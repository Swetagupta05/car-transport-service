<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Vehicle Transport - Harihar Car Carriers</title>
     <base href="./" />
  <link rel="icon" type="image/png" href="../assets/icons/favicon.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Navbar CSS -->
    <link rel="stylesheet" href="../css/components/navbar.css">
    <link rel="stylesheet" href="../css/components/middle-navbar.css">
    <!-- Loading Indicators CSS -->
    <link rel="stylesheet" href="../css/components/loading-indicators.css">
    <link rel="stylesheet" href="../css/styles.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <!-- Leaflet Control Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />

    <!-- Leaflet Plugins for Advanced Features -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <!-- Booking CSS -->
    <link rel="stylesheet" href="../css/components/booking.css">

    <!-- Booking Modals CSS -->
    <link rel="stylesheet" href="../css/components/booking-modals.css">

    <!-- Lottie Animation -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link rel="stylesheet" href="../css/components/glowing-input.css">


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body padding-top handled by navbar.css */
        body {
            font-family: "Poppins", sans-serif;
            background-color: #2b2b2b;
            color: white;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Hero Section */
        .booking-hero {
            padding: 150px 0 80px;
            background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)),
                url('https://images.unsplash.com/photo-1568605117036-5fe5e7bab0b7?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            text-align: center;
        }

        .booking-hero h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .booking-hero p {
            font-size: 1.3rem;
            max-width: 700px;
            margin: 0 auto 30px;
            opacity: 0.9;
        }

        /* Booking Section */
        .booking-section {
            padding: 80px 0;
            background-color: #333;
        }

        .booking-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            align-items: start;
        }

        /* Progress Bar */
        .progress-container {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #444;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: 15px;
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 3px;
            background: #444;
            z-index: 0;
        }

        .progress-line-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6347, #ff4500);
            width: 0%;
            transition: width 0.4s ease;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #444;
            border: 3px solid #444;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .step.active .step-circle {
            background: #ff6347;
            border-color: #ff6347;
            box-shadow: 0 0 20px rgba(255, 99, 71, 0.5);
        }

        .step.completed .step-circle {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .step.completed .step-circle i {
            display: block;
        }

        .step-circle i {
            display: none;
        }

        .step-label {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #999;
            font-weight: 500;
            text-align: center;
        }

        .step.active .step-label {
            color: #ff6347;
        }

        .step.completed .step-label {
            color: #4CAF50;
        }

        .progress-percentage {
            text-align: center;
            color: #ff6347;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* Blackout dates styling */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .date-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.85rem;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .date-warning.show {
            display: flex;
        }

        .date-warning i {
            color: #ffc107;
        }

        /* Form Steps */
        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .step-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #444;
        }

        .step-header h3 {
            color: #ff6347;
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .step-header p {
            color: #999;
            font-size: 0.9rem;
        }

        /* Booking Form */
        .booking-form-container {
            background: linear-gradient(145deg, #2b2b2b, #333);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            position: relative;
        }

        .booking-form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6347, #ff4500);
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .form-header h2 {
            font-size: 2rem;
            color: white;
            margin-bottom: 8px;
        }

        .form-header p {
            color: #ff6347;
            font-size: 1rem;
        }

        .booking-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label i {
            color: #ff6347;
            width: 16px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 10px;
            color: white;
            font-family: "Poppins", sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6347;
            box-shadow: 0 0 0 3px rgba(255, 99, 71, 0.1);
            background: #222;
        }

        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: #ff3860;
            box-shadow: 0 0 0 3px rgba(255, 56, 96, 0.1);
        }

        .form-group.valid input,
        .form-group.valid select {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .validation-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            display: none;
        }

        .validation-icon.success {
            color: #4CAF50;
            display: block;
            animation: checkmark 0.5s ease;
        }

        .validation-icon.error {
            color: #ff3860;
            display: block;
        }

        @keyframes checkmark {
            0% {
                transform: translateY(-50%) scale(0);
            }

            50% {
                transform: translateY(-50%) scale(1.2);
            }

            100% {
                transform: translateY(-50%) scale(1);
            }
        }

        .character-counter {
            font-size: 0.8rem;
            color: #999;
            text-align: right;
            margin-top: 5px;
        }

        .character-counter.warning {
            color: #ffa500;
        }

        .character-counter.danger {
            color: #ff3860;
        }

        .error-message {
            color: #ff3860;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Navigation Buttons */
        .form-navigation {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 25px;
        }

        .booking-nav-btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-family: "Poppins", sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 55px;
        }

        .booking-btn-prev {
            background: #444;
            color: white;
        }

        .booking-btn-prev:hover {
            background: #555;
            transform: translateX(-3px);
        }

        .booking-btn-next {
            background: linear-gradient(135deg, #ff6347, #ff4500);
            color: white;
        }

        .booking-btn-next:hover {
            transform: translateX(3px);
            box-shadow: 0 5px 15px rgba(255, 99, 71, 0.4);
        }

        .booking-btn-prev:disabled,
        .booking-btn-next:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.5;
            transform: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .date-time-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .location-input-wrapper {
            position: relative;
        }

        .map-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff6347;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .map-btn:hover {
            background: #ff4500;
        }

        .booking-submit-btn {
            flex: 1;
            background: linear-gradient(135deg, #ff6347, #ff4500);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-family: "Poppins", sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            min-height: 55px;
            box-shadow: 0 5px 15px rgba(255, 99, 71, 0.3);
        }

        .booking-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 99, 71, 0.4);
            background: linear-gradient(135deg, #ff4500, #ff6347);
        }

        .booking-submit-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .save-later-btn {
            background: transparent;
            color: #ff6347;
            border: 2px solid #ff6347;
            padding: 15px 30px;
            border-radius: 10px;
            font-family: "Poppins", sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            min-height: 55px;
        }

        .save-later-btn:hover {
            background: #ff6347;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 99, 71, 0.3);
        }

        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #1a1a1a;
            color: #4CAF50;
            padding: 10px 20px;
            border-radius: 25px;
            border: 2px solid #4CAF50;
            font-size: 0.85rem;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            animation: slideInLeft 0.3s ease;
        }

        .auto-save-indicator.show {
            display: flex;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal styles moved to booking-modals.css */

        /* Booking Summary Sidebar */
        .booking-summary {
            background: #2b2b2b;
            padding: 25px;
            border-radius: 20px;
            border: 1px solid #444;
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #444;
        }

        .summary-header h3 {
            color: #ff6347;
            font-size: 1.3rem;
        }

        .summary-section {
            margin-bottom: 20px;
        }

        .summary-section h4 {
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: #999;
            font-size: 0.9rem;
        }

        .summary-value {
            color: white;
            font-weight: 500;
            text-align: right;
        }

        .summary-value.empty {
            color: #666;
            font-style: italic;
        }

        .price-calculator {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .price-calculator h4 {
            color: #ff6347;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .price-breakdown {
            margin-bottom: 15px;
        }

        .price-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            color: #ccc;
            font-size: 0.9rem;
        }

        .price-item.total {
            border-top: 2px solid #444;
            margin-top: 10px;
            padding-top: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #ff6347;
        }

        .price-slider-group {
            margin: 15px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 0.85rem;
        }

        .price-slider {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #444;
            outline: none;
            -webkit-appearance: none;
        }

        .price-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff6347;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .price-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(255, 99, 71, 0.5);
        }

        .price-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff6347;
            cursor: pointer;
            border: none;
        }

        .discount-badge {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .summary-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .summary-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-family: "Poppins", sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-download {
            background: #444;
            color: white;
        }

        .btn-download:hover {
            background: #555;
        }

        .btn-print {
            background: transparent;
            color: #ff6347;
            border: 2px solid #ff6347;
        }

        .btn-print:hover {
            background: #ff6347;
            color: white;
        }

        .delivery-estimate {
            background: #333;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
        }

        .delivery-estimate .label {
            color: #999;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .delivery-estimate .date {
            color: #4CAF50;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .distance-estimate {
            background: #333;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
        }

        .distance-estimate .label {
            color: #999;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .distance-estimate .distance {
            color: #ff6347;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .distance-estimate .time {
            color: #ccc;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #444;
            border-top-color: #ff6347;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Autocomplete Dropdown Styles */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1a1a1a;
            border: 2px solid #444;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #ccc;
            border-bottom: 1px solid #333;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.active {
            background: #ff6347;
            color: white;
        }

        .autocomplete-item strong {
            color: #ff6347;
        }

        .autocomplete-item:hover strong {
            color: white;
        }

        /* Map Container */
        .map-section {
            margin-top: 40px;
        }

        .map-container-wrapper {
            background: #2b2b2b;
            padding: 30px;
            border-radius: 20px;
            border: 1px solid #444;
        }

        .map-header {
            margin-bottom: 20px;
        }

        .map-header h3 {
            font-size: 1.5rem;
            color: white;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .map-header p {
            color: #ccc;
            font-size: 0.9rem;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 15px;
            border: 2px solid #444;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        #map:hover {
            box-shadow: 0 15px 40px rgba(255, 99, 71, 0.2);
        }

        .map-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .map-control-btn {
            background: #444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: "Poppins", sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-control-btn:hover {
            background: #ff6347;
        }

        .map-control-btn.active {
            background: #ff6347;
        }

        .route-info {
            background: #333;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .route-info.show {
            display: block;
        }

        .route-info h4 {
            color: #ff6347;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .route-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .route-detail-item {
            flex: 1;
            min-width: 150px;
        }

        .route-detail-item label {
            color: #999;
            font-size: 0.85rem;
            display: block;
            margin-bottom: 5px;
        }

        .route-detail-item span {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Leaflet Custom Styles */
        .leaflet-popup-content-wrapper {
            background: #2b2b2b;
            color: white;
            border-radius: 10px;
        }

        .leaflet-popup-tip {
            background: #2b2b2b;
        }

        .leaflet-control-geocoder {
            background: #2b2b2b;
            border: 2px solid #444;
        }

        .leaflet-control-geocoder input {
            background: #1a1a1a;
            color: white;
            border: 1px solid #444;
        }

        .leaflet-routing-container {
            background: #2b2b2b;
            color: white;
        }

        /* Map Container */
        .map-container-wrapper {
            background: #2b2b2b;
            padding: 30px;
            border-radius: 20px;
            border: 1px solid #444;
        }

        .map-header {
            margin-bottom: 20px;
        }

        .map-header h3 {
            font-size: 1.5rem;
            color: white;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .map-header p {
            color: #ccc;
            font-size: 0.9rem;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 15px;
            border: 2px solid #444;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        #map:hover {
            box-shadow: 0 15px 40px rgba(255, 99, 71, 0.2);
        }

        .map-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .map-control-btn {
            background: #444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: "Poppins", sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-control-btn:hover {
            background: #ff6347;
        }

        .map-control-btn.active {
            background: #ff6347;
        }

        .route-info {
            background: #333;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .route-info.show {
            display: block;
        }

        .route-info h4 {
            color: #ff6347;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .route-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .route-detail-item {
            flex: 1;
            min-width: 150px;
        }

        .route-detail-item label {
            color: #999;
            font-size: 0.85rem;
            display: block;
            margin-bottom: 5px;
        }

        .route-detail-item span {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Success Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #2b2b2b;
            padding: 50px 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 550px;
            width: 90%;
            border: 2px solid #ff6347;
            position: relative;
            animation: modalZoom 0.5s ease;
        }

        @keyframes modalZoom {
            from {
                transform: scale(0.7);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            border-radius: 20px;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff6347;
            animation: confettiFall 3s linear;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .success-animation {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
        }

        .animated-checkmark {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 5px solid #4CAF50;
            margin: 0 auto 20px;
            position: relative;
            animation: scaleUp 0.5s ease;
        }

        @keyframes scaleUp {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .checkmark-circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 5;
            stroke: #4CAF50;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .checkmark-check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            stroke: #4CAF50;
            stroke-width: 5;
            fill: none;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.6s forwards;
        }

        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }

        .booking-reference {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #ff6347;
        }

        .booking-reference .label {
            color: #999;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .booking-reference .ref-number {
            color: #ff6347;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            animation: typeWriter 1s steps(12);
            overflow: hidden;
            white-space: nowrap;
            display: inline-block;
        }

        @keyframes typeWriter {
            from {
                width: 0;
            }

            to {
                width: 100%;
            }
        }

        .modal h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: white;
        }

        .modal p {
            color: #ccc;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-btn {
            background: #ff6347;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-family: "Poppins", sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn:hover {
            background: #ff4500;
            transform: translateY(-2px);
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #2b2b2b;
            color: white;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #ff6347;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 350px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.hide {
            transform: translateX(400px);
            opacity: 0;
        }

        .toast-icon {
            font-size: 1.5rem;
            color: #ff6347;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 0.9rem;
            color: #ccc;
        }

        .toast-close {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Leaflet Custom Styles */
        .leaflet-popup-content-wrapper {
            background: #2b2b2b;
            color: white;
            border-radius: 10px;
        }

        .leaflet-popup-tip {
            background: #2b2b2b;
        }

        .leaflet-control-geocoder {
            background: #2b2b2b;
            border: 2px solid #444;
        }

        .leaflet-control-geocoder input {
            background: #1a1a1a;
            color: white;
            border: 1px solid #444;
        }

        .leaflet-routing-container {
            background: #2b2b2b;
            color: white;
        }

        /* Modal Scroll and Fix */
        .manage-booking-content::-webkit-scrollbar {
            width: 8px;
        }

        .manage-booking-content::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }

        .manage-booking-content::-webkit-scrollbar-thumb {
            background: #ff6347;
            border-radius: 10px;
        }

        .manage-booking-content::-webkit-scrollbar-thumb:hover {
            background: #ff4500;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .booking-container {
                grid-template-columns: 1fr;
            }

            .booking-summary {
                position: static;
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .booking-hero h1 {
                font-size: 2.2rem;
            }

            .booking-form-container,
            .map-container-wrapper {
                padding: 25px 20px;
            }

            .form-row,
            .date-time-row {
                grid-template-columns: 1fr;
            }

            #map {
                height: 400px;
            }

            .route-details {
                flex-direction: column;
            }

            .map-controls {
                justify-content: center;
            }

            .booking-actions-grid {
                grid-template-columns: 1fr;
            }

            .manage-booking-content {
                padding: 25px 20px;
                width: 95%;
            }

            .analytics-grid {
                grid-template-columns: 1fr 1fr;
            }

            .addon-services {
                padding: 15px;
            }
        }

        /* Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }
    </style>
</head>

<body>
    <!-- Navbar Component -->
    <div id="navbar-container"></div>
    <!-- Loading State Manager - Must load first -->
    <script src="../js/modules/loading-state-manager.js"></script>
    <!-- Page Navigation Loader - Must load after loading-state-manager -->
    <script src="../js/modules/page-navigation-loader.js"></script>
    <script src="../js/modules/navbar-loader.js?v=2"></script>

    <!-- Hero Section -->
    <section class="booking-hero">
        <div class="container">
            <h1 class="fade-in">Book Your Vehicle Transport</h1>
            <p class="fade-in">Quick, secure, and reliable vehicle transportation booking with interactive map</p>
        </div>
    </section>

    <!-- Booking Section -->
    <section class="booking-section">
        <div class="container">
            <div class="booking-container">
                <!-- Booking Form -->
                <div class="booking-form-container fade-in">
                    <!-- Progress Bar -->
                    <div class="progress-container">
                        <div class="progress-steps">
                            <div class="progress-line">
                                <div class="progress-line-fill" id="progressFill"></div>
                            </div>
                            <div class="step active" data-step="1">
                                <div class="step-circle">
                                    <span class="step-number">1</span>
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="step-label">Details</div>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-circle">
                                    <span class="step-number">2</span>
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="step-label">Review</div>
                            </div>
                            <div class="step" data-step="3">
                                <div class="step-circle">
                                    <span class="step-number">3</span>
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="step-label">Confirm</div>
                            </div>
                        </div>
                        <div class="progress-percentage" id="progressPercentage">33% Complete</div>
                    </div>

                    <form class="booking-form" id="autoSaveForm">
                        <!-- Step 1: Personal & Vehicle Details -->
                        <div class="form-step active" data-step="1">
                            <div class="step-header">
                                <h3><i class="fas fa-user-circle"></i> Personal & Vehicle Information</h3>
                                <p>Tell us about yourself and your vehicle</p>
                            </div>

                            <!-- Personal Information -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fullName"><i class="fas fa-user"></i> Full Name *</label>
                                    <input type="text" id="fullName" name="fullName" required
                                        placeholder="Enter your full name">
                                    <span class="validation-icon"><i class="fas fa-check-circle"></i></span>
                                    <div class="error-message" id="nameError">Please enter your full name</div>
                                </div>
                                <div class="form-group">
                                    <label for="phone"><i class="fas fa-phone"></i> Phone Number *</label>
                                    <input type="tel" id="phone" name="phone" required
                                        placeholder="Enter 10-digit number">
                                    <span class="validation-icon"><i class="fas fa-check-circle"></i></span>
                                    <div class="error-message" id="phoneError">Please enter a valid 10-digit phone
                                        number</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="email"><i class="fas fa-envelope"></i> Email Address *</label>
                                <input type="email" id="email" name="email" required placeholder="Enter your email">
                                <span class="validation-icon"><i class="fas fa-check-circle"></i></span>
                                <div class="error-message" id="emailError">Please enter a valid email address</div>
                            </div>

                            <!-- Vehicle Information -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="vehicleType"><i class="fas fa-car"></i> Vehicle Type *</label>
                                    <select id="vehicleType" name="vehicleType" required>
                                        <option value="">Select Vehicle Type</option>
                                        <option value="hatchback">Hatchback</option>
                                        <option value="sedan">Sedan</option>
                                        <option value="suv">SUV</option>
                                        <option value="luxury">Luxury Car</option>
                                        <option value="bike">Motorcycle</option>
                                        <option value="commercial">Commercial Vehicle</option>
                                    </select>
                                    <span class="validation-icon"><i class="fas fa-check-circle"></i></span>
                                    <div class="error-message" id="vehicleError">Please select vehicle type</div>
                                </div>
                                <div class="form-group">
                                    <label for="vehicleModel"><i class="fas fa-cog"></i> Vehicle Model</label>
                                    <input type="text" id="vehicleModel" name="vehicleModel"
                                        placeholder="e.g., Hyundai Creta">
                                </div>
                            </div>

                            <!-- Add-on Services -->
                            <div class="addon-services">
                                <h4><i class="fas fa-plus-circle"></i> Add-on Services (Optional)</h4>
                                <div class="addon-grid">
                                    <div class="addon-item" onclick="toggleAddon(this, 'cleaning', 500)">
                                        <input type="checkbox" class="addon-checkbox" id="addonCleaning" name="addons"
                                            value="cleaning">
                                        <i class="fas fa-spray-can addon-icon"></i>
                                        <div class="addon-info">
                                            <div class="addon-name">Interior Cleaning</div>
                                            <div class="addon-desc">Deep cleaning of vehicle interior</div>
                                        </div>
                                        <div class="addon-price">₹500</div>
                                    </div>
                                    <div class="addon-item" onclick="toggleAddon(this, 'detailing', 1500)">
                                        <input type="checkbox" class="addon-checkbox" id="addonDetailing" name="addons"
                                            value="detailing">
                                        <i class="fas fa-star addon-icon"></i>
                                        <div class="addon-info">
                                            <div class="addon-name">Premium Detailing</div>
                                            <div class="addon-desc">Complete exterior & interior detailing</div>
                                        </div>
                                        <div class="addon-price">₹1,500</div>
                                    </div>
                                    <div class="addon-item" onclick="toggleAddon(this, 'insurance', 800)">
                                        <input type="checkbox" class="addon-checkbox" id="addonInsurance" name="addons"
                                            value="insurance">
                                        <i class="fas fa-shield-alt addon-icon"></i>
                                        <div class="addon-info">
                                            <div class="addon-name">Extra Insurance</div>
                                            <div class="addon-desc">Additional coverage up to ₹5 lakhs</div>
                                        </div>
                                        <div class="addon-price">₹800</div>
                                    </div>
                                    <div class="addon-item" onclick="toggleAddon(this, 'express', 2000)">
                                        <input type="checkbox" class="addon-checkbox" id="addonExpress" name="addons"
                                            value="express">
                                        <i class="fas fa-bolt addon-icon"></i>
                                        <div class="addon-info">
                                            <div class="addon-name">Express Delivery</div>
                                            <div class="addon-desc">Priority delivery - 30% faster</div>
                                        </div>
                                        <div class="addon-price">₹2,000</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-navigation">
                                <button type="button" class="booking-nav-btn booking-btn-prev" disabled>
                                    <i class="fas fa-arrow-left"></i> Previous
                                </button>
                                <button type="button" class="booking-nav-btn booking-btn-next" onclick="nextStep()">
                                    Next <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Location & Schedule -->
                        <div class="form-step" data-step="2">
                            <div class="step-header">
                                <h3><i class="fas fa-map-marked-alt"></i> Location & Schedule</h3>
                                <p>Set your pickup and delivery details</p>
                            </div>

                            <!-- Location Information -->
                            <div class="form-group">
                                <label for="pickupCity"><i class="fas fa-map-marker-alt"></i> Pickup City *</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="pickupCity" name="pickupCity" required
                                        placeholder="Start typing city name..." autocomplete="off">
                                    <div class="autocomplete-dropdown" id="pickupCityDropdown"></div>
                                </div>
                                <span class="validation-icon"><i class="fas fa-check-circle"></i></span>
                                <div class="error-message" id="pickupError">Please select pickup city</div>
                            </div>

                            <div class="form-group">
                                <label for="dropCity"><i class="fas fa-flag-checkered"></i> Drop City *</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="dropCity" name="dropCity" required
                                        placeholder="Start typing city name..." autocomplete="off">
                                    <div class="autocomplete-dropdown" id="dropCityDropdown"></div>
                                </div>
                                <span class="validation-icon"><i class="fas fa-check-circle"></i></span>
                                <div class="error-message" id="dropError">Please select drop city</div>
                            </div>

                            <!-- Hidden fields for full addresses (optional) -->
                            <input type="hidden" id="pickupLocation" name="pickupLocation">
                            <input type="hidden" id="dropLocation" name="dropLocation">

                            <!-- Date & Time -->
                            <div class="date-time-row">
                                <div class="form-group">
                                    <label for="pickupDate"><i class="fas fa-calendar"></i> Preferred Pickup Date
                                        *</label>
                                    <input type="date" id="pickupDate" name="pickupDate" required>
                                    <span class="validation-icon"><i class="fas fa-check-circle"></i></span>
                                    <div class="error-message" id="dateError">Please select pickup date</div>
                                    <div class="date-warning" id="dateWarning"></div>
                                </div>
                                <div class="form-group">
                                    <label for="pickupTime"><i class="fas fa-clock"></i> Preferred Time</label>
                                    <select id="pickupTime" name="pickupTime">
                                        <option value="any">Any Time</option>
                                        <option value="morning">Morning (8 AM - 12 PM)</option>
                                        <option value="afternoon">Afternoon (12 PM - 5 PM)</option>
                                        <option value="evening">Evening (5 PM - 8 PM)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Route Optimization with Waypoints -->
                            <div class="waypoints-section">
                                <div class="waypoints-header">
                                    <h4><i class="fas fa-map-signs"></i> Add Stops Along the Way</h4>
                                    <button type="button" class="add-waypoint-btn" onclick="addWaypoint()">
                                        <i class="fas fa-plus"></i> Add Stop
                                    </button>
                                </div>
                                <p style="color: #999; font-size: 0.9rem; margin-bottom: 15px;">
                                    Add intermediate stops for vehicle pickup or drop-off along your route
                                </p>
                                <div class="waypoints-list" id="waypointsList">
                                    <!-- Waypoints will be added dynamically -->
                                </div>
                                <button type="button" class="optimize-route-btn" id="optimizeRouteBtn"
                                    onclick="optimizeRoute()" style="display: none;">
                                    <i class="fas fa-route"></i> Optimize Route Order
                                </button>
                                <div class="optimization-result" id="optimizationResult">
                                    <h5><i class="fas fa-check-circle"></i> Route Optimized!</h5>
                                    <div class="optimization-stats">
                                        <div><i class="fas fa-road"></i> Distance Saved: <strong id="distanceSaved">0
                                                km</strong></div>
                                        <div><i class="fas fa-clock"></i> Time Saved: <strong id="timeSaved">0
                                                mins</strong></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Weather Forecast -->
                            <div class="weather-section" id="weatherSection" style="display: none;">
                                <div class="weather-header">
                                    <i class="fas fa-cloud-sun" style="font-size: 1.5rem;"></i>
                                    <h4>Weather Forecast</h4>
                                </div>
                                <div class="weather-grid" id="weatherGrid">
                                    <div class="weather-loading">
                                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #ff6347;"></i>
                                        <p>Loading weather data...</p>
                                    </div>
                                </div>
                            </div>

                            <div class="form-navigation">
                                <button type="button" class="booking-nav-btn booking-btn-prev" onclick="prevStep()">
                                    <i class="fas fa-arrow-left"></i> Previous
                                </button>
                                <button type="button" class="save-later-btn" onclick="openSaveEmailModal()">
                                    <i class="fas fa-save"></i> Save & Continue Later
                                </button>
                                <button type="button" class="booking-nav-btn booking-btn-next" onclick="nextStep()">
                                    Next <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Review & Confirm -->
                        <div class="form-step" data-step="3">
                            <div class="step-header">
                                <h3><i class="fas fa-clipboard-check"></i> Review & Confirm</h3>
                                <p>Verify your booking details before confirmation</p>
                            </div>

                            <!-- Additional Information -->
                            <div class="form-group">
                                <label for="additionalInfo"><i class="fas fa-comment"></i> Additional
                                    Information</label>
                                <textarea id="additionalInfo" name="additionalInfo"
                                    placeholder="Any special requirements or instructions..." rows="4"
                                    maxlength="500"></textarea>
                                <div class="character-counter">
                                    <span id="charCount">0</span> / 500 characters
                                </div>
                            </div>

                            <!-- Review Summary -->
                            <div class="review-summary">
                                <h4 style="color: #ff6347; margin-bottom: 15px;">
                                    <i class="fas fa-eye"></i> Booking Summary
                                </h4>
                                <div id="reviewContent"
                                    style="background: #1a1a1a; padding: 20px; border-radius: 10px;">
                                    <!-- Summary will be populated dynamically -->
                                </div>
                            </div>

                            <div class="form-navigation">
                                <button type="button" class="booking-nav-btn booking-btn-prev" onclick="prevStep()">
                                    <i class="fas fa-arrow-left"></i> Previous
                                </button>
                                <button type="submit" class="booking-submit-btn" id="submitBtn">
                                    <i class="fas fa-paper-plane"></i>
                                    <span>Confirm Booking</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Booking Summary Sidebar -->
                <div class="booking-summary fade-in">
                    <div class="summary-header">
                        <i class="fas fa-receipt" style="font-size: 1.5rem;"></i>
                        <h3>Booking Summary</h3>
                    </div>

                    <!-- Price Calculator -->
                    <div class="price-calculator">
                        <h4><i class="fas fa-calculator"></i> Price Estimate</h4>

                        <div class="price-slider-group">
                            <div class="slider-label">
                                <span>Distance</span>
                                <span id="distanceValue">0 km</span>
                            </div>
                            <input type="range" class="price-slider" id="distanceSlider" min="0" max="2000" value="0"
                                step="10">
                        </div>

                        <div class="price-breakdown" id="priceBreakdown">
                            <div class="price-item">
                                <span>Base Fare:</span>
                                <span id="baseFare">₹ 0</span>
                            </div>
                            <div class="price-item">
                                <span>Distance Charge:</span>
                                <span id="distanceCharge">₹ 0</span>
                            </div>
                            <div class="price-item" id="addonsTotal" style="display: none;">
                                <span>Add-on Services:</span>
                                <span id="addonsPrice">₹ 0</span>
                            </div>
                            <div class="price-item">
                                <span>GST (18%):</span>
                                <span id="gst">₹ 0</span>
                            </div>
                            <div class="price-item total">
                                <span>Total Amount:</span>
                                <span id="totalPrice">₹ 0</span>
                            </div>
                        </div>

                        <div class="discount-badge" id="discountBadge" style="display: none;">
                            <i class="fas fa-tag"></i> 10% First Booking Discount Applied!
                        </div>
                    </div>

                    <!-- Popular Routes -->
                    <div class="popular-routes" style="margin-bottom: 20px;">
                        <h5><i class="fas fa-fire" style="color: #ff6347;"></i> Popular Routes</h5>
                        <div class="route-item" style="cursor: pointer;" onclick="fillRoute('Mumbai', 'Delhi')">
                            <div class="route-cities">
                                <span>Mumbai</span>
                                <i class="fas fa-arrow-right route-arrow"></i>
                                <span>Delhi</span>
                            </div>
                            <div class="route-stats">
                                <span class="route-stat"><strong>1,424</strong> km</span>
                                <span class="peak-indicator high"><i class="fas fa-fire"></i> High Demand</span>
                            </div>
                        </div>
                        <div class="route-item" style="cursor: pointer;" onclick="fillRoute('Bangalore', 'Hyderabad')">
                            <div class="route-cities">
                                <span>Bangalore</span>
                                <i class="fas fa-arrow-right route-arrow"></i>
                                <span>Hyderabad</span>
                            </div>
                            <div class="route-stats">
                                <span class="route-stat"><strong>569</strong> km</span>
                            </div>
                        </div>
                        <div class="route-item" style="cursor: pointer;" onclick="fillRoute('Pune', 'Goa')">
                            <div class="route-cities">
                                <span>Pune</span>
                                <i class="fas fa-arrow-right route-arrow"></i>
                                <span>Goa</span>
                            </div>
                            <div class="route-stats">
                                <span class="route-stat"><strong>464</strong> km</span>
                                <span class="peak-indicator"><i class="fas fa-chart-line"></i> Trending</span>
                            </div>
                        </div>
                    </div>

                    <!-- Distance Estimate -->
                    <div class="distance-estimate" id="distanceEstimate">
                        <div class="label">Estimated Distance</div>
                        <div class="distance" style="color: #666;">Select cities to calculate</div>
                    </div>

                    <!-- Popular Routes -->
                    <div class="popular-routes" style="margin-bottom: 20px;">
                        <h5><i class="fas fa-fire" style="color: #ff6347;"></i> Popular Routes</h5>
                        <div class="route-item" style="cursor: pointer;" onclick="fillRoute('Mumbai', 'Delhi')">
                            <div class="route-cities">
                                <span>Mumbai</span>
                                <i class="fas fa-arrow-right route-arrow"></i>
                                <span>Delhi</span>
                            </div>
                            <div class="route-stats">
                                <span class="route-stat"><strong>1,424</strong> km</span>
                                <span class="peak-indicator high"><i class="fas fa-fire"></i> High Demand</span>
                            </div>
                        </div>
                        <div class="route-item" style="cursor: pointer;" onclick="fillRoute('Bangalore', 'Hyderabad')">
                            <div class="route-cities">
                                <span>Bangalore</span>
                                <i class="fas fa-arrow-right route-arrow"></i>
                                <span>Hyderabad</span>
                            </div>
                            <div class="route-stats">
                                <span class="route-stat"><strong>569</strong> km</span>
                            </div>
                        </div>
                        <div class="route-item" style="cursor: pointer;" onclick="fillRoute('Pune', 'Goa')">
                            <div class="route-cities">
                                <span>Pune</span>
                                <i class="fas fa-arrow-right route-arrow"></i>
                                <span>Goa</span>
                            </div>
                            <div class="route-stats">
                                <span class="route-stat"><strong>464</strong> km</span>
                                <span class="peak-indicator"><i class="fas fa-chart-line"></i> Trending</span>
                            </div>
                        </div>
                    </div>

                    <!-- Booking Details -->
                    <div class="summary-section">
                        <h4>Personal Info</h4>
                        <div class="summary-item">
                            <span class="summary-label">Name:</span>
                            <span class="summary-value empty" id="summaryName">Not provided</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Phone:</span>
                            <span class="summary-value empty" id="summaryPhone">Not provided</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Email:</span>
                            <span class="summary-value empty" id="summaryEmail">Not provided</span>
                        </div>
                    </div>

                    <div class="summary-section">
                        <h4>Vehicle Details</h4>
                        <div class="summary-item">
                            <span class="summary-label">Type:</span>
                            <span class="summary-value empty" id="summaryVehicleType">Not selected</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Model:</span>
                            <span class="summary-value empty" id="summaryVehicleModel">Not provided</span>
                        </div>
                    </div>

                    <div class="summary-section">
                        <h4>Transport Details</h4>
                        <div class="summary-item">
                            <span class="summary-label">From:</span>
                            <span class="summary-value empty" id="summaryPickup">Not set</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">To:</span>
                            <span class="summary-value empty" id="summaryDrop">Not set</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Date:</span>
                            <span class="summary-value empty" id="summaryDate">Not selected</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Time:</span>
                            <span class="summary-value empty" id="summaryTime">Any time</span>
                        </div>
                    </div>

                    <!-- Delivery Estimate -->
                    <div class="delivery-estimate">
                        <div class="label">Estimated Delivery Date</div>
                        <div class="date" id="estimatedDelivery">Select pickup date</div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="summary-actions">
                        <button class="summary-btn btn-download" onclick="downloadPDF()">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                        <button class="summary-btn btn-print" onclick="printSummary()">
                            <i class="fas fa-print"></i> Print Summary
                        </button>
                    </div>
                </div>
            </div>

            <!-- Interactive Map Section -->
            <div class="map-section" style="margin-top: 40px;">
                <div class="map-container-wrapper fade-in">
                    <div class="map-header">
                        <h3>
                            <i class="fas fa-map-marked-alt"></i>
                            Interactive Location Map
                        </h3>
                        <p>View the route between selected cities or explore locations</p>
                    </div>

                    <div id="map" style="position: relative;"></div>
                    <div class="map-3d-indicator" id="map3DIndicator">
                        <i class="fas fa-cube"></i> 3D View Active
                    </div>

                    <div class="map-controls">
                        <button class="map-control-btn" id="satelliteViewBtn" onclick="toggleSatelliteView()">
                            <i class="fas fa-satellite"></i> Satellite View
                        </button>
                        <button class="map-control-btn" id="enable3DBtn" onclick="toggle3DView()">
                            <i class="fas fa-cube"></i> 3D View
                        </button>
                        <button class="map-control-btn" id="trafficLayerBtn" onclick="toggleTrafficLayer()">
                            <i class="fas fa-traffic-light"></i> Traffic
                        </button>
                        <button class="map-control-btn" id="serviceCentersBtn" onclick="toggleServiceCenters()">
                            <i class="fas fa-tools"></i> Service Centers
                        </button>
                        <button class="map-control-btn" id="restStopsBtn" onclick="toggleRestStops()">
                            <i class="fas fa-coffee"></i> Rest Stops
                        </button>
                        <button class="map-control-btn" id="tollPlazasBtn" onclick="toggleTollPlazas()">
                            <i class="fas fa-coins"></i> Toll Plazas
                        </button>
                        <button class="map-control-btn" id="alternativeRoutesBtn" onclick="toggleAlternativeRoutes()">
                            <i class="fas fa-code-branch"></i> Alt Routes
                        </button>
                        <button class="map-control-btn" id="streetViewBtn" onclick="openStreetViewPanel()">
                            <i class="fas fa-street-view"></i> Street View
                        </button>
                        <button class="map-control-btn" id="clearRouteBtn" onclick="clearRoute()">
                            <i class="fas fa-trash"></i> Clear Route
                        </button>
                        <button class="map-control-btn" id="centerMapBtn" onclick="centerMap()">
                            <i class="fas fa-crosshairs"></i> Center Map
                        </button>
                    </div>

                    <!-- Street View Panel -->
                    <div class="street-view-panel" id="streetViewPanel" style="display: none;">
                        <div class="street-view-header">
                            <h4><i class="fas fa-street-view"></i> Street View Preview</h4>
                            <button class="close-street-view" onclick="closeStreetViewPanel()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="street-view-content">
                            <iframe id="streetViewFrame" width="100%" height="400" frameborder="0"
                                style="border:0; border-radius: 10px;"></iframe>
                            <p style="color: #999; font-size: 0.85rem; margin-top: 10px; text-align: center;">
                                Click on the map to preview street view at that location
                            </p>
                        </div>
                    </div>

                    <!-- Alternative Routes Comparison -->
                    <div class="alternative-routes-panel" id="alternativeRoutesPanel" style="display: none;">
                        <h4><i class="fas fa-code-branch"></i> Alternative Routes Comparison</h4>
                        <div class="routes-comparison" id="routesComparison">
                            <!-- Routes will be populated dynamically -->
                        </div>
                    </div>

                    <div class="route-info" id="routeInfo">
                        <h4><i class="fas fa-info-circle"></i> Route Information</h4>
                        <div class="route-details">
                            <div class="route-detail-item">
                                <label>Distance</label>
                                <span id="routeDistance">-- km</span>
                            </div>
                            <div class="route-detail-item">
                                <label>Estimated Time</label>
                                <span id="routeTime">-- hours</span>
                            </div>
                            <div class="route-detail-item">
                                <label>Estimated Cost</label>
                                <span id="routeCost">₹ --</span>
                            </div>
                            <div class="route-detail-item">
                                <label>Toll Cost</label>
                                <span id="routeTollCost">₹ --</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="confetti-container" id="confettiContainer"></div>

            <!-- Animated Checkmark SVG -->
            <svg class="success-animation" viewBox="0 0 52 52">
                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
                <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
            </svg>

            <h3>🎉 Booking Confirmed!</h3>
            <p>Thank you for choosing Harihar Car Carriers. Your booking has been successfully submitted.</p>

            <div class="booking-reference">
                <div class="label">Booking Reference Number</div>
                <div class="ref-number" id="bookingRef">HC2024-001</div>
            </div>

            <p style="font-size: 0.9rem; color: #999;">
                A confirmation email has been sent to your registered email address.
                Our team will contact you within 24 hours.
            </p>

            <button class="modal-btn" onclick="closeModal()">
                <i class="fas fa-check"></i> Got It!
            </button>

            <button class="modal-btn" onclick="closeModal(); openManageBooking();"
                style="background: #444; margin-top: 10px;">
                <i class="fas fa-edit"></i> Manage Booking
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Auto-Save Indicator -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        <i class="fas fa-check-circle"></i>
        <span>Draft saved automatically</span>
    </div>

    <!-- Floating Manage Booking Button (for testing) -->
    <button onclick="openManageBooking()"
        style="position: fixed; bottom: 100px; right: 20px; z-index: 999; background: linear-gradient(135deg, #ff6347, #ff4500); color: white; border: none; padding: 15px 25px; border-radius: 50px; font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; box-shadow: 0 5px 20px rgba(255, 99, 71, 0.4); display: flex; align-items: center; gap: 10px; transition: all 0.3s ease;"
        onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(255, 99, 71, 0.5)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 20px rgba(255, 99, 71, 0.4)'">
        <i class="fas fa-edit"></i>
        <span>Manage Booking</span>
    </button>

    <!-- Save Email Modal -->
    <div class="save-email-modal" id="saveEmailModal">
        <div class="save-email-content">
            <h3><i class="fas fa-envelope"></i> Save & Continue Later</h3>
            <p>Enter your email to receive a link to continue this booking later.</p>
            <input type="email" class="save-email-input" id="saveEmail" name="saveEmail" placeholder="your.email@example.com" />
            <div class="save-email-actions">
                <button class="btn-send-link" onclick="sendSaveLink()">
                    <i class="fas fa-paper-plane"></i> Send Link
                </button>
                <button class="btn-cancel-save" onclick="closeSaveEmailModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Booking Modal -->
    <div class="manage-booking-modal" id="manageBookingModal">
        <div class="manage-booking-content">
            <div class="manage-booking-header">
                <h3><i class="fas fa-edit"></i> Manage Booking</h3>
                <button class="close-modal-btn" onclick="closeManageBooking()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="booking-actions-grid">
                <div class="action-card" onclick="editBooking()">
                    <i class="fas fa-pencil-alt"></i>
                    <h4>Edit Details</h4>
                    <p>Modify booking information</p>
                </div>
                <div class="action-card" onclick="openRescheduleModal()">
                    <i class="fas fa-calendar-alt"></i>
                    <h4>Reschedule</h4>
                    <p>Change pickup date/time</p>
                </div>
                <div class="action-card" onclick="openCancelModal()">
                    <i class="fas fa-times-circle"></i>
                    <h4>Cancel Booking</h4>
                    <p>Cancel with refund</p>
                </div>
                <div class="action-card" onclick="openTransferModal()">
                    <i class="fas fa-user-friends"></i>
                    <h4>Transfer Booking</h4>
                    <p>Transfer to another person</p>
                </div>
                <div class="action-card" onclick="openUpgradeModal()">
                    <i class="fas fa-arrow-up"></i>
                    <h4>Upgrade/Downgrade</h4>
                    <p>Change vehicle type</p>
                </div>
                <div class="action-card" onclick="openAddonsModal()">
                    <i class="fas fa-plus-square"></i>
                    <h4>Add Services</h4>
                    <p>Add cleaning, detailing</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reschedule Modal -->
    <div class="manage-booking-modal" id="rescheduleModal">
        <div class="manage-booking-content">
            <div class="manage-booking-header">
                <h3><i class="fas fa-calendar-alt"></i> Reschedule Booking</h3>
                <button class="close-modal-btn" onclick="closeRescheduleModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="form-group">
                <label for="newPickupDate"><i class="fas fa-calendar"></i> New Pickup Date</label>
                <input type="date" id="newPickupDate" name="newPickupDate" class="save-email-input" style="margin-bottom: 15px;">
            </div>

            <div class="form-group">
                <label for="newPickupTime"><i class="fas fa-clock"></i> New Pickup Time</label>
                <select id="newPickupTime" class="save-email-input" style="margin-bottom: 15px;">
                    <option value="any">Any Time</option>
                    <option value="morning">Morning (8 AM - 12 PM)</option>
                    <option value="afternoon">Afternoon (12 PM - 5 PM)</option>
                    <option value="evening">Evening (5 PM - 8 PM)</option>
                </select>
            </div>

            <div class="fee-structure">
                <h4><i class="fas fa-receipt"></i> Rescheduling Fee</h4>
                <div class="fee-item">
                    <span>More than 48 hours before pickup</span>
                    <span class="fee-amount">FREE</span>
                </div>
                <div class="fee-item">
                    <span>24-48 hours before pickup</span>
                    <span class="fee-amount">₹500</span>
                </div>
                <div class="fee-item">
                    <span>Less than 24 hours</span>
                    <span class="fee-amount">₹1,000</span>
                </div>
            </div>

            <div class="save-email-actions">
                <button class="btn-send-link" onclick="confirmReschedule()">
                    <i class="fas fa-check"></i> Confirm Reschedule
                </button>
                <button class="btn-cancel-save" onclick="closeRescheduleModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Cancel Booking Modal -->
    <div class="manage-booking-modal" id="cancelModal">
        <div class="manage-booking-content">
            <div class="manage-booking-header">
                <h3><i class="fas fa-times-circle"></i> Cancel Booking</h3>
                <button class="close-modal-btn" onclick="closeCancelModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="refund-policy">
                <h4><i class="fas fa-money-bill-wave"></i> Refund Policy</h4>
                <div class="refund-tier">
                    <i class="fas fa-check-circle tier-icon" style="color: #4CAF50;"></i>
                    <div class="tier-info">
                        <div class="tier-label">More than 72 hours</div>
                        <div class="tier-desc">Cancel more than 3 days before pickup</div>
                    </div>
                    <div class="tier-amount">100%</div>
                </div>
                <div class="refund-tier">
                    <i class="fas fa-info-circle tier-icon" style="color: #FFC107;"></i>
                    <div class="tier-info">
                        <div class="tier-label">48-72 hours</div>
                        <div class="tier-desc">Cancel 2-3 days before pickup</div>
                    </div>
                    <div class="tier-amount">75%</div>
                </div>
                <div class="refund-tier">
                    <i class="fas fa-exclamation-circle tier-icon" style="color: #FF9800;"></i>
                    <div class="tier-info">
                        <div class="tier-label">24-48 hours</div>
                        <div class="tier-desc">Cancel 1-2 days before pickup</div>
                    </div>
                    <div class="tier-amount">50%</div>
                </div>
                <div class="refund-tier">
                    <i class="fas fa-times-circle tier-icon" style="color: #ff6347;"></i>
                    <div class="tier-info">
                        <div class="tier-label">Less than 24 hours</div>
                        <div class="tier-desc">Cancel within 24 hours of pickup</div>
                    </div>
                    <div class="tier-amount">25%</div>
                </div>
            </div>

            <div class="form-group">
                <label for="cancelReason"><i class="fas fa-comment"></i> Reason for Cancellation</label>
                <textarea id="cancelReason" class="save-email-input" rows="3"
                    placeholder="Please tell us why you're cancelling..."></textarea>
            </div>

            <div class="save-email-actions">
                <button class="btn-send-link" style="background: #dc3545;" onclick="confirmCancellation()">
                    <i class="fas fa-trash"></i> Confirm Cancellation
                </button>
                <button class="btn-cancel-save" onclick="closeCancelModal()">
                    Keep Booking
                </button>
            </div>
        </div>
    </div>

    <!-- Transfer Booking Modal -->
    <div class="manage-booking-modal" id="transferModal">
        <div class="manage-booking-content">
            <div class="manage-booking-header">
                <h3><i class="fas fa-user-friends"></i> Transfer Booking</h3>
                <button class="close-modal-btn" onclick="closeTransferModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <p style="color: #ccc; margin-bottom: 20px;">Transfer this booking to another person. They will receive all
                booking details and notifications.</p>

            <div class="form-group">
                <label for="transferName"><i class="fas fa-user"></i> Recipient Name</label>
                <input type="text" id="transferName" name="transferName" class="save-email-input" placeholder="Enter full name">
            </div>

            <div class="form-group">
                <label for="transferEmail"><i class="fas fa-envelope"></i> Recipient Email</label>
                <input type="email" id="transferEmail" name="transferEmail" class="save-email-input" placeholder="Enter email address">
            </div>

            <div class="form-group">
                <label for="transferPhone"><i class="fas fa-phone"></i> Recipient Phone</label>
                <input type="tel" id="transferPhone" name="transferPhone" class="save-email-input" placeholder="Enter 10-digit phone number">
            </div>

            <div class="fee-structure">
                <h4><i class="fas fa-receipt"></i> Transfer Fee</h4>
                <div class="fee-item">
                    <span>Booking transfer processing fee</span>
                    <span class="fee-amount">₹200</span>
                </div>
            </div>

            <div class="save-email-actions">
                <button class="btn-send-link" onclick="confirmTransfer()">
                    <i class="fas fa-exchange-alt"></i> Transfer Booking
                </button>
                <button class="btn-cancel-save" onclick="closeTransferModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Upgrade/Downgrade Modal -->
    <div class="manage-booking-modal" id="upgradeModal">
        <div class="manage-booking-content">
            <div class="manage-booking-header">
                <h3><i class="fas fa-arrow-up"></i> Change Vehicle Type</h3>
                <button class="close-modal-btn" onclick="closeUpgradeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <p style="color: #ccc; margin-bottom: 20px;">Current Vehicle: <strong id="currentVehicleType"
                    style="color: #ff6347;">Sedan</strong></p>

            <div class="form-group">
                <label for="newVehicleType"><i class="fas fa-car"></i> Select New Vehicle Type</label>
                <select id="newVehicleType" class="save-email-input" onchange="calculateUpgradeFee()">
                    <option value="">Select Vehicle Type</option>
                    <option value="hatchback">Hatchback (Downgrade -₹500)</option>
                    <option value="sedan">Sedan (Current)</option>
                    <option value="suv">SUV (Upgrade +₹1,000)</option>
                    <option value="luxury">Luxury Car (Upgrade +₹2,500)</option>
                    <option value="bike">Motorcycle (Downgrade -₹1,000)</option>
                </select>
            </div>

            <div class="fee-structure" id="upgradeFeeStructure" style="display: none;">
                <h4><i class="fas fa-calculator"></i> Price Adjustment</h4>
                <div class="fee-item">
                    <span>Original Price</span>
                    <span class="fee-amount" id="originalPrice">₹5,000</span>
                </div>
                <div class="fee-item">
                    <span id="adjustmentLabel">Upgrade Fee</span>
                    <span class="fee-amount" id="adjustmentAmount">+₹1,000</span>
                </div>
                <div class="fee-item" style="border-top: 2px solid #444; padding-top: 10px; margin-top: 10px;">
                    <span style="font-weight: 600;">New Total</span>
                    <span class="fee-amount" id="newTotalPrice" style="font-size: 1.2rem;">₹6,000</span>
                </div>
            </div>

            <div class="save-email-actions">
                <button class="btn-send-link" onclick="confirmVehicleChange()">
                    <i class="fas fa-check"></i> Confirm Change
                </button>
                <button class="btn-cancel-save" onclick="closeUpgradeModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Abandonment Banner -->
    <div class="abandonment-banner" id="abandonmentBanner">
        <div class="abandonment-content">
            <i class="fas fa-gift abandonment-icon"></i>
            <div class="abandonment-text">
                <h4>Still thinking? Get 10% off! 🎉</h4>
                <p>Complete your booking in the next 10 minutes and save ₹<span id="discountAmount">500</span></p>
            </div>
            <button class="abandonment-close" onclick="closeAbandonmentBanner()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet Routing Machine -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <!-- Leaflet Control Geocoder -->
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>

    <!-- Leaflet Marker Cluster -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Booking Modals Module -->
    <script src="../js/modules/booking-modals.js"></script>

    <script>
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        let map;
        let pickupMarker;
        let dropMarker;
        let routingControl;
        let pickupCoords = null;
        let dropCoords = null;
        let selectingPickup = false;
        let selectingDrop = false;
        let currentStep = 1;
        let formData = {};
        let autoSaveTimeout = null;
        let estimatedDistance = 0;
        let estimatedDuration = 0;

        // Advanced Map Features
        let satelliteLayer = null;
        let streetLayer = null;
        let trafficLayer = null;
        let serviceCentersLayer = null;
        let restStopsLayer = null;
        let tollPlazasLayer = null;
        let is3DView = false;
        let showAlternativeRoutes = false;
        let alternativeRoutesControls = [];
        let currentMapStyle = 'street';
        let streetViewActive = false;

        // Blackout dates (holidays, maintenance days, etc.)
        const blackoutDates = [
            '2025-11-15', // Diwali
            '2025-12-25', // Christmas
            '2025-12-31', // New Year's Eve
            '2026-01-01', // New Year's Day
            '2026-01-26', // Republic Day
            '2026-03-08', // Holi
            '2026-08-15', // Independence Day
            '2026-10-02', // Gandhi Jayanti
        ];

        // City coordinates database for distance calculation
        const cityCoordinates = {
            'Mumbai': [19.0760, 72.8777],
            'Delhi': [28.7041, 77.1025],
            'Bangalore': [12.9716, 77.5946],
            'Hyderabad': [17.3850, 78.4867],
            'Ahmedabad': [23.0225, 72.5714],
            'Chennai': [13.0827, 80.2707],
            'Kolkata': [22.5726, 88.3639],
            'Pune': [18.5204, 73.8567],
            'Jaipur': [26.9124, 75.7873],
            'Surat': [21.1702, 72.8311],
            'Lucknow': [26.8467, 80.9462],
            'Kanpur': [26.4499, 80.3319],
            'Nagpur': [21.1458, 79.0882],
            'Indore': [22.7196, 75.8577],
            'Thane': [19.2183, 72.9781],
            'Bhopal': [23.2599, 77.4126],
            'Visakhapatnam': [17.6868, 83.2185],
            'Patna': [25.5941, 85.1376],
            'Vadodara': [22.3072, 73.1812],
            'Ghaziabad': [28.6692, 77.4538],
            'Ludhiana': [30.9010, 75.8573],
            'Agra': [27.1767, 78.0081],
            'Nashik': [19.9975, 73.7898],
            'Meerut': [28.9845, 77.7064],
            'Rajkot': [22.3039, 70.8022],
            'Varanasi': [25.3176, 82.9739],
            'Srinagar': [34.0837, 74.7973],
            'Amritsar': [31.6340, 74.8723],
            'Coimbatore': [11.0168, 76.9558],
            'Jodhpur': [26.2389, 73.0243],
            'Madurai': [9.9252, 78.1198],
            'Chandigarh': [30.7333, 76.7794],
            'Guwahati': [26.1445, 91.7362],
            'Mysore': [12.2958, 76.6394],
            'Gurgaon': [28.4595, 77.0266],
            'Bhubaneswar': [20.2961, 85.8245],
            'Kochi': [9.9312, 76.2673],
            'Dehradun': [30.3165, 78.0322],
            'Mangalore': [12.9141, 74.8560],
            'Goa': [15.2993, 74.1240],
            'Panaji': [15.4909, 73.8278]
        };

        // ========================================
        // MULTI-STEP FORM MANAGEMENT
        // ========================================
        function nextStep() {
            if (!validateStep(currentStep)) {
                showToast('Validation Error', 'Please fill all required fields correctly', 'error', 3000);
                return;
            }

            if (currentStep < 3) {
                currentStep++;
                updateStepDisplay();
                updateProgressBar();
                if (currentStep === 3) {
                    populateReviewSummary();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
                updateProgressBar();
            }
        }

        function updateStepDisplay() {
            // Hide all steps
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.remove('active');
            });

            // Show current step
            document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.add('active');

            // Update step indicators
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');

                if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                }
            });

            // Scroll to top of form
            document.querySelector('.booking-form-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updateProgressBar() {
            const progress = ((currentStep - 1) / 2) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressPercentage').textContent = Math.round((currentStep / 3) * 100) + '% Complete';
        }

        // ========================================
        // AUTO-SAVE TO LOCALSTORAGE
        // ========================================
        function autoSaveForm() {
            const form = document.getElementById('bookingForm');
            const formData = new FormData(form);
            const data = {
                step: currentStep,
                timestamp: new Date().toISOString(),
                fields: {}
            };

            // Save all form fields
            for (let [key, value] of formData.entries()) {
                data.fields[key] = value;
            }

            // Save coordinates if set
            if (pickupCoords) data.pickupCoords = pickupCoords;
            if (dropCoords) data.dropCoords = dropCoords;

            localStorage.setItem('bookingDraft', JSON.stringify(data));

            // Show auto-save indicator
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function restoreFormData() {
            const savedData = localStorage.getItem('bookingDraft');
            if (!savedData) return;

            try {
                const data = JSON.parse(savedData);
                const savedTime = new Date(data.timestamp);
                const now = new Date();
                const hoursSinceLastSave = (now - savedTime) / (1000 * 60 * 60);

                // Only restore if saved within last 7 days
                if (hoursSinceLastSave > 168) {
                    localStorage.removeItem('bookingDraft');
                    return;
                }

                // Ask user if they want to restore
                if (confirm(`Found a draft booking from ${formatTimeAgo(savedTime)}. Would you like to continue where you left off?`)) {
                    // Restore form fields
                    Object.keys(data.fields).forEach(key => {
                        const input = document.getElementById(key);
                        if (input) {
                            input.value = data.fields[key];
                            // Trigger validation
                            validateField(key, data.fields[key]);
                        }
                    });

                    // Restore step
                    currentStep = data.step || 1;
                    updateStepDisplay();
                    updateProgressBar();

                    // Restore coordinates and map
                    // Wait for map to be fully initialized
                    const restoreMapData = () => {
                        console.log('Restoring map data...', data);

                        if (data.pickupCoords) {
                            pickupCoords = data.pickupCoords;
                            console.log('Restoring pickup coords:', pickupCoords);
                            setPickupLocation(pickupCoords[0], pickupCoords[1], data.fields.pickupLocation || data.fields.pickupCity || 'Saved location');
                        } else if (data.fields.pickupCity) {
                            // Try to get coordinates from city name
                            const pickupCity = data.fields.pickupCity;
                            console.log('Getting pickup coords for city:', pickupCity);
                            const pickupCoord = cityCoordinates[pickupCity];
                            if (pickupCoord) {
                                console.log('Found pickup coords:', pickupCoord);
                                pickupCoords = pickupCoord;
                                setPickupLocation(pickupCoord[0], pickupCoord[1], pickupCity);
                            }
                        }

                        if (data.dropCoords) {
                            dropCoords = data.dropCoords;
                            console.log('Restoring drop coords:', dropCoords);
                            setDropLocation(dropCoords[0], dropCoords[1], data.fields.dropLocation || data.fields.dropCity || 'Saved location');
                        } else if (data.fields.dropCity) {
                            // Try to get coordinates from city name
                            const dropCity = data.fields.dropCity;
                            console.log('Getting drop coords for city:', dropCity);
                            const dropCoord = cityCoordinates[dropCity];
                            if (dropCoord) {
                                console.log('Found drop coords:', dropCoord);
                                dropCoords = dropCoord;
                                setDropLocation(dropCoord[0], dropCoord[1], dropCity);
                            }
                        }

                        // Calculate route if both coordinates are available
                        setTimeout(() => {
                            if (pickupCoords && dropCoords) {
                                console.log('Calculating route with coords:', pickupCoords, dropCoords);
                                calculateRoute();
                            } else {
                                console.log('Cannot calculate route. Pickup:', pickupCoords, 'Drop:', dropCoords);
                            }
                        }, 1500);
                    };

                    // Ensure map is initialized before restoring markers
                    if (map && map._loaded) {
                        console.log('Map is ready, restoring data immediately');
                        setTimeout(restoreMapData, 500);
                    } else {
                        console.log('Map not ready, waiting 2 seconds');
                        setTimeout(() => {
                            if (map) {
                                console.log('Map ready after wait');
                                restoreMapData();
                            } else {
                                console.error('Map still not initialized');
                            }
                        }, 2000);
                    }

                    // Update summary
                    updateBookingSummary();
                    calculateDistanceEstimate();

                    showToast('Restored', 'Your draft booking has been restored', 'success', 3000);
                } else {
                    localStorage.removeItem('bookingDraft');
                }
            } catch (e) {
                console.error('Error restoring form data:', e);
                localStorage.removeItem('bookingDraft');
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            return `${days} day${days !== 1 ? 's' : ''} ago`;
        }

        function triggerAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSaveForm, 1000); // Debounce by 1 second
        }

        function validateStep(step) {
            let isValid = true;

            if (step === 1) {
                // Validate personal and vehicle info
                const fields = ['fullName', 'phone', 'email', 'vehicleType'];
                fields.forEach(field => {
                    const input = document.getElementById(field);
                    if (!validateField(field, input.value)) {
                        isValid = false;
                    }
                });
            } else if (step === 2) {
                // Validate location and schedule
                const fields = ['pickupCity', 'dropCity', 'pickupDate'];
                fields.forEach(field => {
                    const input = document.getElementById(field);
                    if (!validateField(field, input.value)) {
                        isValid = false;
                    }
                });
            }

            return isValid;
        }

        function populateReviewSummary() {
            const reviewContent = document.getElementById('reviewContent');
            const formData = new FormData(document.getElementById('bookingForm'));

            let html = '<div style="display: grid; gap: 15px;">';

            // Personal Info
            html += '<div>';
            html += '<h5 style="color: #ff6347; margin-bottom: 10px;"><i class="fas fa-user"></i> Personal Information</h5>';
            html += `<p style="color: #ccc; margin: 5px 0;"><strong>Name:</strong> ${formData.get('fullName') || 'Not provided'}</p>`;
            html += `<p style="color: #ccc; margin: 5px 0;"><strong>Phone:</strong> ${formData.get('phone') || 'Not provided'}</p>`;
            html += `<p style="color: #ccc; margin: 5px 0;"><strong>Email:</strong> ${formData.get('email') || 'Not provided'}</p>`;
            html += '</div>';

            // Vehicle Info
            html += '<div>';
            html += '<h5 style="color: #ff6347; margin-bottom: 10px;"><i class="fas fa-car"></i> Vehicle Details</h5>';
            html += `<p style="color: #ccc; margin: 5px 0;"><strong>Type:</strong> ${formatVehicleType(formData.get('vehicleType'))}</p>`;
            html += `<p style="color: #ccc; margin: 5px 0;"><strong>Model:</strong> ${formData.get('vehicleModel') || 'Not specified'}</p>`;
            html += '</div>';

            // Transport Details
            html += '<div>';
            html += '<h5 style="color: #ff6347; margin-bottom: 10px;"><i class="fas fa-route"></i> Transport Details</h5>';
            const pickupCity = formData.get('pickupCity') || formData.get('pickupLocation') || 'Not set';
            const dropCity = formData.get('dropCity') || formData.get('dropLocation') || 'Not set';
            html += `<p style="color: #ccc; margin: 5px 0;"><strong>From:</strong> ${pickupCity}</p>`;
            html += `<p style="color: #ccc; margin: 5px 0;"><strong>To:</strong> ${dropCity}</p>`;
            html += `<p style="color: #ccc; margin: 5px 0;"><strong>Date:</strong> ${formatDate(formData.get('pickupDate'))}</p>`;
            html += `<p style="color: #ccc; margin: 5px 0;"><strong>Time:</strong> ${formatTime(formData.get('pickupTime'))}</p>`;
            html += '</div>';

            html += '</div>';
            reviewContent.innerHTML = html;
        }

        function formatVehicleType(type) {
            const types = {
                'hatchback': 'Hatchback',
                'sedan': 'Sedan',
                'suv': 'SUV',
                'luxury': 'Luxury Car',
                'bike': 'Motorcycle',
                'commercial': 'Commercial Vehicle'
            };
            return types[type] || type;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Not selected';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function formatTime(time) {
            const times = {
                'any': 'Any Time',
                'morning': 'Morning (8 AM - 12 PM)',
                'afternoon': 'Afternoon (12 PM - 5 PM)',
                'evening': 'Evening (5 PM - 8 PM)'
            };
            return times[time] || 'Any Time';
        }

        // ========================================
        // DISTANCE ESTIMATION
        // ========================================
        function calculateDistanceEstimate() {
            const pickupCity = document.getElementById('pickupCity').value;
            const dropCity = document.getElementById('dropCity').value;

            if (!pickupCity || !dropCity) {
                estimatedDistance = 0;
                estimatedDuration = 0;
                updateDistanceDisplay();
                return;
            }

            const pickup = cityCoordinates[pickupCity];
            const drop = cityCoordinates[dropCity];

            if (pickup && drop) {
                // Calculate haversine distance
                const R = 6371; // Earth's radius in km
                const lat1 = pickup[0] * Math.PI / 180;
                const lat2 = drop[0] * Math.PI / 180;
                const deltaLat = (drop[0] - pickup[0]) * Math.PI / 180;
                const deltaLon = (drop[1] - pickup[1]) * Math.PI / 180;

                const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                estimatedDistance = Math.round(R * c);
                // Estimate driving time at 60 km/h average
                estimatedDuration = Math.round((estimatedDistance / 60) * 10) / 10;

                // Update distance slider
                const distanceSlider = document.getElementById('distanceSlider');
                if (distanceSlider) {
                    distanceSlider.value = estimatedDistance;
                    document.getElementById('distanceValue').textContent = estimatedDistance + ' km';
                }

                updateDistanceDisplay();
                updatePriceCalculation();
                showToast('Distance Calculated', `Estimated ${estimatedDistance} km (~${estimatedDuration} hours)`, 'success', 3000);
            }
        }

        function updateDistanceDisplay() {
            const distanceEstimate = document.getElementById('distanceEstimate');
            if (!distanceEstimate) return;

            if (estimatedDistance > 0) {
                distanceEstimate.innerHTML = `
                    <div class="label">Estimated Distance</div>
                    <div class="distance">${estimatedDistance} km</div>
                    <div class="time">~${estimatedDuration} hours drive time</div>
                `;
            } else {
                distanceEstimate.innerHTML = `
                    <div class="label">Estimated Distance</div>
                    <div class="distance" style="color: #666;">Select cities to calculate</div>
                `;
            }
        }

        // ========================================
        // BLACKOUT DATES VALIDATION
        // ========================================
        function checkBlackoutDate(dateString) {
            if (!dateString) return false;
            return blackoutDates.includes(dateString);
        }

        function validatePickupDate() {
            const dateInput = document.getElementById('pickupDate');
            const dateValue = dateInput.value;
            const dateWarning = document.getElementById('dateWarning');

            if (!dateValue) {
                if (dateWarning) dateWarning.classList.remove('show');
                return true;
            }

            // Check if it's a blackout date
            if (checkBlackoutDate(dateValue)) {
                if (dateWarning) {
                    dateWarning.innerHTML = '<i class="fas fa-exclamation-triangle"></i> This date is unavailable due to holiday/maintenance. Please select another date.';
                    dateWarning.classList.add('show');
                }
                dateInput.value = '';
                showToast('Date Unavailable', 'Selected date is a blackout date. Please choose another.', 'warning', 4000);
                return false;
            }

            // Check if it's a Sunday (optional restriction)
            const selectedDate = new Date(dateValue);
            if (selectedDate.getDay() === 0) {
                if (dateWarning) {
                    dateWarning.innerHTML = '<i class="fas fa-info-circle"></i> Sunday bookings may have limited availability.';
                    dateWarning.classList.add('show');
                }
            } else {
                if (dateWarning) dateWarning.classList.remove('show');
            }

            return true;
        }

        // ========================================
        // REAL-TIME VALIDATION
        // ========================================
        function validateField(fieldName, value) {
            const validators = {
                fullName: (val) => val.trim().length >= 2,
                phone: (val) => /^[6-9]\d{9}$/.test(val.replace(/\D/g, '')),
                email: (val) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val),
                vehicleType: (val) => val.trim() !== '',
                pickupCity: (val) => val.trim() !== '',
                dropCity: (val) => val.trim() !== '',
                pickupLocation: (val) => val.trim() !== '',
                dropLocation: (val) => val.trim() !== '',
                pickupDate: (val) => val !== ''
            };

            const validator = validators[fieldName];
            if (!validator) return true;

            const isValid = validator(value);
            const input = document.getElementById(fieldName);
            const errorElement = document.getElementById(fieldName + 'Error');
            const formGroup = input.closest('.form-group');
            const validationIcon = formGroup.querySelector('.validation-icon');

            if (isValid) {
                input.classList.remove('error');
                formGroup.classList.add('valid');
                if (errorElement) errorElement.style.display = 'none';
                if (validationIcon) {
                    validationIcon.className = 'validation-icon success';
                }
            } else {
                input.classList.add('error');
                formGroup.classList.remove('valid');
                if (errorElement) {
                    errorElement.style.display = 'block';
                    errorElement.textContent = getErrorMessage(fieldName);
                }
                if (validationIcon) {
                    validationIcon.className = 'validation-icon error';
                }
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 500);
            }

            return isValid;
        }

        function getErrorMessage(field) {
            const messages = {
                fullName: 'Please enter your full name (min 2 characters)',
                phone: 'Please enter a valid 10-digit Indian phone number',
                email: 'Please enter a valid email address',
                vehicleType: 'Please select vehicle type',
                pickupCity: 'Please select pickup city',
                dropCity: 'Please select drop city',
                pickupLocation: 'Please enter pickup location',
                dropLocation: 'Please enter drop location',
                pickupDate: 'Please select pickup date'
            };
            return messages[field] || 'This field is required';
        }

        // ========================================
        // BOOKING SUMMARY LIVE UPDATE
        // ========================================
        function updateBookingSummary() {
            const formData = new FormData(document.getElementById('bookingForm'));

            // Update personal info
            updateSummaryField('summaryName', formData.get('fullName'));
            updateSummaryField('summaryPhone', formData.get('phone'));
            updateSummaryField('summaryEmail', formData.get('email'));

            // Update vehicle details
            updateSummaryField('summaryVehicleType', formatVehicleType(formData.get('vehicleType')));
            updateSummaryField('summaryVehicleModel', formData.get('vehicleModel') || 'Not provided');

            // Update transport details (use city names primarily)
            const pickupCity = formData.get('pickupCity') || formData.get('pickupLocation');
            const dropCity = formData.get('dropCity') || formData.get('dropLocation');
            updateSummaryField('summaryPickup', pickupCity, 'Not set');
            updateSummaryField('summaryDrop', dropCity, 'Not set');
            updateSummaryField('summaryDate', formatDate(formData.get('pickupDate')), 'Not selected');
            updateSummaryField('summaryTime', formatTime(formData.get('pickupTime')));

            // Update delivery estimate
            if (formData.get('pickupDate')) {
                const pickupDate = new Date(formData.get('pickupDate'));
                const deliveryDate = new Date(pickupDate);
                const distance = parseFloat(document.getElementById('distanceSlider').value);
                const days = Math.ceil(distance / 400) + 1; // Approx 400km per day
                deliveryDate.setDate(deliveryDate.getDate() + days);

                document.getElementById('estimatedDelivery').textContent =
                    deliveryDate.toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
            }
        }

        function updateSummaryField(elementId, value, defaultText = 'Not provided') {
            const element = document.getElementById(elementId);
            if (value && value.trim() !== '') {
                element.textContent = value;
                element.classList.remove('empty');
            } else {
                element.textContent = defaultText;
                element.classList.add('empty');
            }
        }

        // ========================================
        // PRICE CALCULATOR
        // ========================================
        function updatePriceCalculation() {
            const distance = parseFloat(document.getElementById('distanceSlider').value);
            const vehicleType = document.getElementById('vehicleType').value;

            // Base fare based on vehicle type
            const baseFares = {
                'hatchback': 2000,
                'sedan': 2500,
                'suv': 3500,
                'luxury': 5000,
                'bike': 1500,
                'commercial': 4000
            };

            const baseFare = baseFares[vehicleType] || 2000;
            const distanceCharge = distance * 15; // ₹15 per km
            const subtotal = baseFare + distanceCharge;
            const gst = subtotal * 0.18;
            let total = subtotal + gst;

            // Apply discount for first booking (10%)
            const isFirstBooking = true; // This would be determined by user session/database
            if (isFirstBooking && distance > 0) {
                total = total * 0.9;
                document.getElementById('discountBadge').style.display = 'block';
            } else {
                document.getElementById('discountBadge').style.display = 'none';
            }

            // Update display with animation
            animateValue('baseFare', baseFare);
            animateValue('distanceCharge', distanceCharge);
            animateValue('gst', gst);
            animateValue('totalPrice', total);

            document.getElementById('distanceValue').textContent = distance + ' km';
        }

        function animateValue(elementId, endValue) {
            const element = document.getElementById(elementId);
            const startValue = parseFloat(element.textContent.replace(/[₹,]/g, '')) || 0;
            const duration = 500;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentValue = startValue + (endValue - startValue) * progress;
                element.textContent = '₹ ' + Math.round(currentValue).toLocaleString('en-IN');

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        // ========================================
        // CONFETTI ANIMATION
        // ========================================
        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#ff6347', '#4CAF50', '#2196F3', '#FFC107', '#9C27B0', '#FF9800'];

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                container.appendChild(confetti);

                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, 4000);
            }
        }

        // ========================================
        // PDF & PRINT FUNCTIONS
        // ========================================
        function downloadPDF() {
            showToast('Download', 'PDF generation feature coming soon!', 'info', 3000);
            // This would integrate with a PDF library like jsPDF
        }

        function printSummary() {
            window.print();
        }

        // ========================================
        // SAVE & CONTINUE LATER
        // ========================================
        // Functions moved to booking-modals.js

        // ========================================
        // CHARACTER COUNTER
        // ========================================
        function updateCharacterCount() {
            const textarea = document.getElementById('additionalInfo');
            const counter = document.getElementById('charCount');
            const count = textarea.value.length;
            const maxLength = 500;

            counter.textContent = count;
            counter.parentElement.classList.remove('warning', 'danger');

            if (count > maxLength * 0.9) {
                counter.parentElement.classList.add('danger');
            } else if (count > maxLength * 0.7) {
                counter.parentElement.classList.add('warning');
            }
        }

        // ========================================
        // MAP FUNCTIONS
        // ========================================
        // Indian Cities Database for Autocomplete
        const indianCities = [
            'Mumbai', 'Delhi', 'Bangalore', 'Hyderabad', 'Ahmedabad', 'Chennai', 'Kolkata',
            'Pune', 'Jaipur', 'Surat', 'Lucknow', 'Kanpur', 'Nagpur', 'Indore', 'Thane',
            'Bhopal', 'Visakhapatnam', 'Pimpri-Chinchwad', 'Patna', 'Vadodara', 'Ghaziabad',
            'Ludhiana', 'Agra', 'Nashik', 'Faridabad', 'Meerut', 'Rajkot', 'Kalyan-Dombivali',
            'Vasai-Virar', 'Varanasi', 'Srinagar', 'Aurangabad', 'Dhanbad', 'Amritsar',
            'Navi Mumbai', 'Allahabad', 'Ranchi', 'Howrah', 'Coimbatore', 'Jabalpur',
            'Gwalior', 'Vijayawada', 'Jodhpur', 'Madurai', 'Raipur', 'Kota', 'Chandigarh',
            'Guwahati', 'Solapur', 'Hubli-Dharwad', 'Mysore', 'Tiruchirappalli', 'Bareilly',
            'Moradabad', 'Mysuru', 'Gurgaon', 'Aligarh', 'Jalandhar', 'Bhubaneswar',
            'Salem', 'Mira-Bhayandar', 'Warangal', 'Guntur', 'Bhiwandi', 'Saharanpur',
            'Gorakhpur', 'Bikaner', 'Amravati', 'Noida', 'Jamshedpur', 'Bhilai', 'Cuttack',
            'Firozabad', 'Kochi', 'Nellore', 'Bhavnagar', 'Dehradun', 'Durgapur', 'Asansol',
            'Siliguri', 'Rourkela', 'Mangalore', 'Tiruppur', 'Belgaum', 'Ujjain', 'Jamnagar'
        ];

        let selectedPickupCity = '';
        let selectedDropCity = '';

        // Setup autocomplete for city inputs
        function setupCityAutocomplete() {
            const pickupInput = document.getElementById('pickupCity');
            const dropInput = document.getElementById('dropCity');

            if (pickupInput) {
                setupAutocomplete(pickupInput, 'pickupCityDropdown', (city) => {
                    selectedPickupCity = city;
                    document.getElementById('pickupLocation').value = city + ', India';
                    updateBookingSummary();
                    // Fetch weather for pickup city
                    fetchWeatherData(city, 'pickup');
                    if (selectedDropCity) {
                        calculateRouteForCities();
                    }
                });
            }

            if (dropInput) {
                setupAutocomplete(dropInput, 'dropCityDropdown', (city) => {
                    selectedDropCity = city;
                    document.getElementById('dropLocation').value = city + ', India';
                    updateBookingSummary();
                    // Fetch weather for drop city
                    fetchWeatherData(city, 'drop');
                    if (selectedPickupCity) {
                        calculateRouteForCities();
                    }
                });
            }
        }

        function setupAutocomplete(inputElement, dropdownId, onSelectCallback) {
            const dropdown = document.getElementById(dropdownId);
            let currentFocus = -1;

            inputElement.addEventListener('input', function () {
                const value = this.value.trim();
                dropdown.innerHTML = '';
                currentFocus = -1;

                if (!value) {
                    dropdown.classList.remove('show');
                    return;
                }

                const matches = indianCities.filter(city =>
                    city.toLowerCase().includes(value.toLowerCase())
                ).slice(0, 8);

                if (matches.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }

                matches.forEach((city, index) => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';

                    const regex = new RegExp(`(${value})`, 'gi');
                    const highlightedText = city.replace(regex, '<strong>$1</strong>');
                    item.innerHTML = highlightedText;

                    item.addEventListener('click', function () {
                        inputElement.value = city;
                        dropdown.classList.remove('show');
                        if (onSelectCallback) {
                            onSelectCallback(city);
                        }
                    });

                    dropdown.appendChild(item);
                });

                dropdown.classList.add('show');
            });

            inputElement.addEventListener('keydown', function (e) {
                const items = dropdown.getElementsByClassName('autocomplete-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    setActive(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    setActive(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus > -1 && items[currentFocus]) {
                        items[currentFocus].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });

            function setActive(items) {
                Array.from(items).forEach((item, index) => {
                    item.classList.remove('active');
                    if (index === currentFocus) {
                        item.classList.add('active');
                        item.scrollIntoView({ block: 'nearest' });
                    }
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (e.target !== inputElement) {
                    dropdown.classList.remove('show');
                }
            });
        }

        function calculateRouteForCities() {
            if (!selectedPickupCity || !selectedDropCity) return;

            // Geocode both cities and show route
            geocodeCity(selectedPickupCity, (pickupLatLng) => {
                geocodeCity(selectedDropCity, (dropLatLng) => {
                    if (pickupLatLng && dropLatLng) {
                        pickupCoords = pickupLatLng;
                        dropCoords = dropLatLng;
                        setPickupLocation(pickupLatLng[0], pickupLatLng[1], selectedPickupCity + ', India');
                        setDropLocation(dropLatLng[0], dropLatLng[1], selectedDropCity + ', India');

                        // Estimate distance between cities and update slider
                        const distance = estimateDistance(pickupLatLng, dropLatLng);
                        const distanceSlider = document.getElementById('distanceSlider');
                        if (distanceSlider) {
                            distanceSlider.value = Math.round(distance);
                            updatePriceCalculation();
                        }
                    }
                });
            });
        }

        function estimateDistance(coord1, coord2) {
            // Haversine formula to calculate distance between two coordinates
            const R = 6371; // Radius of Earth in km
            const dLat = (coord2[0] - coord1[0]) * Math.PI / 180;
            const dLon = (coord2[1] - coord1[1]) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(coord1[0] * Math.PI / 180) * Math.cos(coord2[0] * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function geocodeCity(cityName, callback) {
            fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(cityName)}&country=India&format=json&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        callback([parseFloat(data[0].lat), parseFloat(data[0].lon)]);
                    } else {
                        callback(null);
                    }
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    callback(null);
                });
        }

        function initMap() {
            // Create map centered on India
            map = L.map('map').setView([20.5937, 78.9629], 5);

            // Add OpenStreetMap tiles (default street layer)
            streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // Satellite layer (initially hidden)
            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 19
            });

            // Add geocoder (search) control
            const geocoder = L.Control.geocoder({
                defaultMarkGeocode: false,
                placeholder: 'Search location...',
                errorMessage: 'Location not found'
            })
                .on('markgeocode', function (e) {
                    const latlng = e.geocode.center;
                    map.setView(latlng, 13);

                    if (selectingPickup) {
                        setPickupLocation(latlng.lat, latlng.lng, e.geocode.name);
                    } else if (selectingDrop) {
                        setDropLocation(latlng.lat, latlng.lng, e.geocode.name);
                    }
                })
                .addTo(map);

            // Add click event to map
            map.on('click', function (e) {
                if (streetViewActive) {
                    showStreetView(e.latlng.lat, e.latlng.lng);
                } else if (selectingPickup) {
                    reverseGeocode(e.latlng.lat, e.latlng.lng, 'pickup');
                } else if (selectingDrop) {
                    reverseGeocode(e.latlng.lat, e.latlng.lng, 'drop');
                }
            });

            // Initialize marker cluster groups
            serviceCentersLayer = L.markerClusterGroup();
            restStopsLayer = L.markerClusterGroup();
            tollPlazasLayer = L.markerClusterGroup();
        }

        // Reverse geocoding
        function reverseGeocode(lat, lng, type) {
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
                .then(response => response.json())
                .then(data => {
                    const address = data.display_name;
                    if (type === 'pickup') {
                        setPickupLocation(lat, lng, address);
                    } else if (type === 'drop') {
                        setDropLocation(lat, lng, address);
                    }
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    showToast('Error', 'Could not get address for this location', 'error', 3000);
                });
        }

        // Set pickup location
        function setPickupLocation(lat, lng, address) {
            pickupCoords = [lat, lng];

            if (pickupMarker) {
                map.removeLayer(pickupMarker);
            }

            const pickupIcon = L.divIcon({
                html: '<i class="fas fa-map-marker-alt" style="color: #4CAF50; font-size: 32px;"></i>',
                className: 'custom-div-icon',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            });

            pickupMarker = L.marker([lat, lng], {
                icon: pickupIcon,
                draggable: true
            }).addTo(map);

            pickupMarker.bindPopup('<b>Pickup Location</b><br>' + address).openPopup();

            pickupMarker.on('dragend', function (e) {
                const newPos = e.target.getLatLng();
                reverseGeocode(newPos.lat, newPos.lng, 'pickup');
            });

            document.getElementById('pickupLocation').value = address;
            selectingPickup = false;

            showToast('Success', 'Pickup location set!', 'success', 2000);

            if (dropCoords) {
                calculateRoute();
            }
        }

        // Set drop location
        function setDropLocation(lat, lng, address) {
            dropCoords = [lat, lng];

            if (dropMarker) {
                map.removeLayer(dropMarker);
            }

            const dropIcon = L.divIcon({
                html: '<i class="fas fa-flag-checkered" style="color: #ff6347; font-size: 32px;"></i>',
                className: 'custom-div-icon',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            });

            dropMarker = L.marker([lat, lng], {
                icon: dropIcon,
                draggable: true
            }).addTo(map);

            dropMarker.bindPopup('<b>Drop Location</b><br>' + address).openPopup();

            dropMarker.on('dragend', function (e) {
                const newPos = e.target.getLatLng();
                reverseGeocode(newPos.lat, newPos.lng, 'drop');
            });

            document.getElementById('dropLocation').value = address;
            selectingDrop = false;

            showToast('Success', 'Drop location set!', 'success', 2000);

            if (pickupCoords) {
                calculateRoute();
            }
        }

        // Select pickup on map
        function selectPickupOnMap() {
            selectingPickup = true;
            selectingDrop = false;
            showToast('Info', 'Click on the map to select pickup location', 'info', 3000);
        }

        // Select drop on map
        function selectDropOnMap() {
            selectingDrop = true;
            selectingPickup = false;
            showToast('Info', 'Click on the map to select drop location', 'info', 3000);
        }

        // Calculate and show route
        function calculateRoute() {
            if (!pickupCoords || !dropCoords) {
                showToast('Warning', 'Please select both pickup and drop locations', 'warning', 3000);
                return;
            }

            if (routingControl) {
                map.removeControl(routingControl);
            }

            // If alternative routes are shown, don't create standard route
            if (showAlternativeRoutes) {
                return;
            }

            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(pickupCoords[0], pickupCoords[1]),
                    L.latLng(dropCoords[0], dropCoords[1])
                ],
                routeWhileDragging: false,
                showAlternatives: false,
                lineOptions: {
                    styles: [{ color: '#ff6347', opacity: 0.8, weight: 5 }]
                },
                createMarker: function () { return null; }, // Don't create default markers
                addWaypoints: false
            }).addTo(map);

            routingControl.on('routesfound', function (e) {
                const route = e.routes[0];
                const distance = (route.summary.totalDistance / 1000).toFixed(2);
                const time = (route.summary.totalTime / 3600).toFixed(1);
                const cost = Math.round(distance * 15); // ₹15 per km estimate

                estimatedDistance = parseFloat(distance);
                estimatedDuration = parseFloat(time);

                document.getElementById('routeDistance').textContent = distance + ' km';
                document.getElementById('routeTime').textContent = time + ' hours';
                document.getElementById('routeCost').textContent = '₹ ' + cost.toLocaleString();

                document.getElementById('routeInfo').classList.add('show');

                showToast('Route Found', `Distance: ${distance}km, Time: ${time}hrs`, 'success', 4000);
            });

            // Fit bounds to show entire route
            const bounds = L.latLngBounds([pickupCoords, dropCoords]);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // Show route
        function showRoute() {
            calculateRoute();
        }

        // Clear route
        function clearRoute() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }

            if (pickupMarker) {
                map.removeLayer(pickupMarker);
                pickupMarker = null;
            }

            if (dropMarker) {
                map.removeLayer(dropMarker);
                dropMarker = null;
            }

            // Clear alternative routes
            clearAlternativeRoutes();

            // Hide alternative routes panel
            if (showAlternativeRoutes) {
                document.getElementById('alternativeRoutesPanel').style.display = 'none';
                document.getElementById('alternativeRoutesBtn').classList.remove('active');
                showAlternativeRoutes = false;
            }

            pickupCoords = null;
            dropCoords = null;

            document.getElementById('pickupLocation').value = '';
            document.getElementById('dropLocation').value = '';
            document.getElementById('routeInfo').classList.remove('show');

            showToast('Cleared', 'Route and markers cleared', 'info', 2000);
        }

        // Center map
        function centerMap() {
            if (pickupCoords && dropCoords) {
                const bounds = L.latLngBounds([pickupCoords, dropCoords]);
                map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                map.setView([20.5937, 78.9629], 5);
            }
        }

        // ========================================
        // ADVANCED MAP FEATURES
        // ========================================

        // Toggle Satellite View
        function toggleSatelliteView() {
            const btn = document.getElementById('satelliteViewBtn');

            if (currentMapStyle === 'street') {
                map.removeLayer(streetLayer);
                map.addLayer(satelliteLayer);
                currentMapStyle = 'satellite';
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-map"></i> Street View';
                showToast('View Changed', 'Switched to satellite view', 'success', 2000);
            } else {
                map.removeLayer(satelliteLayer);
                map.addLayer(streetLayer);
                currentMapStyle = 'street';
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-satellite"></i> Satellite View';
                showToast('View Changed', 'Switched to street view', 'success', 2000);
            }
        }

        // Toggle 3D View (Tilt effect simulation)
        function toggle3DView() {
            const btn = document.getElementById('enable3DBtn');
            const mapContainer = document.getElementById('map');
            const indicator = document.getElementById('map3DIndicator');

            is3DView = !is3DView;

            if (is3DView) {
                mapContainer.style.transform = 'perspective(1000px) rotateX(30deg)';
                mapContainer.style.transition = 'transform 0.5s ease';
                btn.classList.add('active');
                indicator.classList.add('show');
                showToast('3D View', '3D perspective enabled', 'success', 2000);
            } else {
                mapContainer.style.transform = 'none';
                btn.classList.remove('active');
                indicator.classList.remove('show');
                showToast('3D View', '3D perspective disabled', 'info', 2000);
            }
        }

        // Toggle Traffic Layer (Mock implementation - would need real traffic API)
        function toggleTrafficLayer() {
            const btn = document.getElementById('trafficLayerBtn');

            if (!trafficLayer) {
                // Mock traffic layer - in production, use Google Maps Traffic Layer or similar
                // For demonstration, we'll show a toast
                trafficLayer = true;
                btn.classList.add('active');
                showToast('Traffic Layer', 'Traffic layer enabled (demo mode)', 'success', 2000);

                // In production, you would integrate with a real traffic API:
                // Example: Google Maps, TomTom, HERE Maps, etc.
            } else {
                trafficLayer = null;
                btn.classList.remove('active');
                showToast('Traffic Layer', 'Traffic layer disabled', 'info', 2000);
            }
        }

        // Toggle Service Centers
        function toggleServiceCenters() {
            const btn = document.getElementById('serviceCentersBtn');

            if (!map.hasLayer(serviceCentersLayer)) {
                // Add service centers to map
                loadServiceCenters();
                map.addLayer(serviceCentersLayer);
                btn.classList.add('active');
                showToast('Service Centers', 'Showing nearby service centers', 'success', 2000);
            } else {
                map.removeLayer(serviceCentersLayer);
                btn.classList.remove('active');
                showToast('Service Centers', 'Service centers hidden', 'info', 2000);
            }
        }

        // Load Service Centers (mock data - would fetch from API in production)
        function loadServiceCenters() {
            serviceCentersLayer.clearLayers();

            // Mock service center locations across India
            const serviceCenters = [
                { name: 'Harihar Service Center - Mumbai', lat: 19.0760, lng: 72.8777, phone: '+91 9876543210' },
                { name: 'Harihar Service Center - Delhi', lat: 28.7041, lng: 77.1025, phone: '+91 9876543211' },
                { name: 'Harihar Service Center - Bangalore', lat: 12.9716, lng: 77.5946, phone: '+91 9876543212' },
                { name: 'Harihar Service Center - Pune', lat: 18.5204, lng: 73.8567, phone: '+91 9876543213' },
                { name: 'Harihar Service Center - Chennai', lat: 13.0827, lng: 80.2707, phone: '+91 9876543214' },
                { name: 'Harihar Service Center - Hyderabad', lat: 17.3850, lng: 78.4867, phone: '+91 9876543215' }
            ];

            const serviceIcon = L.divIcon({
                html: '<i class=\"fas fa-tools\" style=\"color: #2196F3; font-size: 24px;\"></i>',
                className: 'custom-div-icon',
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            });

            serviceCenters.forEach(center => {
                const marker = L.marker([center.lat, center.lng], { icon: serviceIcon });
                marker.bindPopup(`
                    <div class=\"custom-marker-popup\">
                        <h5><i class=\"fas fa-tools\"></i> ${center.name}</h5>
                        <p><i class=\"fas fa-phone\"></i> ${center.phone}</p>
                        <p><i class=\"fas fa-clock\"></i> 24/7 Service</p>
                    </div>
                `);
                serviceCentersLayer.addLayer(marker);
            });
        }

        // Toggle Rest Stops
        function toggleRestStops() {
            const btn = document.getElementById('restStopsBtn');

            if (!map.hasLayer(restStopsLayer)) {
                loadRestStops();
                map.addLayer(restStopsLayer);
                btn.classList.add('active');
                showToast('Rest Stops', 'Showing recommended rest stops', 'success', 2000);
            } else {
                map.removeLayer(restStopsLayer);
                btn.classList.remove('active');
                showToast('Rest Stops', 'Rest stops hidden', 'info', 2000);
            }
        }

        // Load Rest Stops (mock data)
        function loadRestStops() {
            restStopsLayer.clearLayers();

            // Mock rest stop locations
            const restStops = [
                { name: 'Highway Dhaba - NH48', lat: 19.5, lng: 73.2, amenities: 'Food, Washroom, Fuel' },
                { name: 'Rest Area - NH44', lat: 15.3, lng: 75.7, amenities: 'Food, Washroom, Parking' },
                { name: 'Service Plaza - NH1', lat: 29.5, lng: 76.8, amenities: 'Food, Fuel, ATM' },
                { name: 'Roadside Cafe - NH27', lat: 24.5, lng: 73.7, amenities: 'Food, Washroom' },
                { name: 'Highway Rest Stop - NH66', lat: 11.2, lng: 75.8, amenities: 'Food, Washroom, Fuel' }
            ];

            const restIcon = L.divIcon({
                html: '<i class=\"fas fa-coffee\" style=\"color: #795548; font-size: 24px;\"></i>',
                className: 'custom-div-icon',
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            });

            restStops.forEach(stop => {
                const marker = L.marker([stop.lat, stop.lng], { icon: restIcon });
                marker.bindPopup(`
                    <div class=\"custom-marker-popup\">
                        <h5><i class=\"fas fa-coffee\"></i> ${stop.name}</h5>
                        <p><i class=\"fas fa-map-marker-alt\"></i> Highway Rest Stop</p>
                        <p><i class=\"fas fa-check-circle\"></i> ${stop.amenities}</p>
                    </div>
                `);
                restStopsLayer.addLayer(marker);
            });
        }

        // Toggle Toll Plazas
        function toggleTollPlazas() {
            const btn = document.getElementById('tollPlazasBtn');

            if (!map.hasLayer(tollPlazasLayer)) {
                loadTollPlazas();
                map.addLayer(tollPlazasLayer);
                btn.classList.add('active');
                showToast('Toll Plazas', 'Showing toll plaza locations', 'success', 2000);
            } else {
                map.removeLayer(tollPlazasLayer);
                btn.classList.remove('active');
                showToast('Toll Plazas', 'Toll plazas hidden', 'info', 2000);
            }
        }

        // Load Toll Plazas (mock data)
        function loadTollPlazas() {
            tollPlazasLayer.clearLayers();

            // Mock toll plaza locations
            const tollPlazas = [
                { name: 'Khalapur Toll Plaza', lat: 18.8329, lng: 73.1986, cost: '₹145', highway: 'Mumbai-Pune Expressway' },
                { name: 'Sriperumbudur Toll Plaza', lat: 12.9634, lng: 79.9406, cost: '₹85', highway: 'NH48' },
                { name: 'Kherki Daula Toll Plaza', lat: 28.3820, lng: 76.8450, cost: '₹95', highway: 'NH48' },
                { name: 'Panipat Toll Plaza', lat: 29.3909, lng: 76.9635, cost: '₹120', highway: 'NH44' },
                { name: 'Vadodara Toll Plaza', lat: 22.3072, lng: 73.1812, cost: '₹75', highway: 'NH48' }
            ];

            let totalTollCost = 0;

            const tollIcon = L.divIcon({
                html: '<i class=\"fas fa-coins\" style=\"color: #FFC107; font-size: 24px;\"></i>',
                className: 'custom-div-icon',
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            });

            tollPlazas.forEach(toll => {
                const marker = L.marker([toll.lat, toll.lng], { icon: tollIcon });
                marker.bindPopup(`
                    <div class=\"custom-marker-popup\">
                        <h5><i class=\"fas fa-coins\"></i> ${toll.name}</h5>
                        <p><i class=\"fas fa-road\"></i> ${toll.highway}</p>
                        <p><i class=\"fas fa-rupee-sign\"></i> Estimated: ${toll.cost}</p>
                    </div>
                `);
                tollPlazasLayer.addLayer(marker);

                // Extract numeric value for total
                const costValue = parseInt(toll.cost.replace(/[^0-9]/g, ''));
                totalTollCost += costValue;
            });

            // Update toll cost in route info
            document.getElementById('routeTollCost').textContent = '₹ ' + totalTollCost;
        }

        // Toggle Alternative Routes
        function toggleAlternativeRoutes() {
            const btn = document.getElementById('alternativeRoutesBtn');
            const panel = document.getElementById('alternativeRoutesPanel');

            showAlternativeRoutes = !showAlternativeRoutes;

            if (showAlternativeRoutes) {
                if (!pickupCoords || !dropCoords) {
                    showToast('Error', 'Please select pickup and drop locations first', 'error', 3000);
                    return;
                }

                loadAlternativeRoutes();
                panel.style.display = 'block';
                btn.classList.add('active');
                showToast('Alternative Routes', 'Showing route options', 'success', 2000);
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
                clearAlternativeRoutes();
            }
        }

        // Load Alternative Routes
        function loadAlternativeRoutes() {
            const panel = document.getElementById('routesComparison');

            // Clear existing routes
            clearAlternativeRoutes();

            // Mock alternative routes data
            const routes = [
                {
                    id: 'route-1',
                    label: 'Route 1 - Fastest',
                    distance: '450 km',
                    time: '6.5 hours',
                    toll: '₹340',
                    badge: 'fastest',
                    waypoints: [pickupCoords, dropCoords],
                    color: '#4CAF50'
                },
                {
                    id: 'route-2',
                    label: 'Route 2 - Shortest',
                    distance: '420 km',
                    time: '7.2 hours',
                    toll: '₹280',
                    badge: 'shortest',
                    waypoints: [pickupCoords, dropCoords],
                    color: '#2196F3'
                },
                {
                    id: 'route-3',
                    label: 'Route 3 - Toll-Free',
                    distance: '485 km',
                    time: '8.5 hours',
                    toll: '₹0',
                    badge: 'toll-free',
                    waypoints: [pickupCoords, dropCoords],
                    color: '#FFC107'
                }
            ];

            panel.innerHTML = routes.map((route, index) => `
                <div class=\"route-option ${index === 0 ? 'active' : ''}\" onclick=\"selectAlternativeRoute('${route.id}', ${index})\">\n                    <div class=\"route-option-info\">\n                        <div class=\"route-option-label\">${route.label}</div>\n                        <div class=\"route-option-details\">\n                            <span><i class=\"fas fa-road\"></i> ${route.distance}</span>\n                            <span><i class=\"fas fa-clock\"></i> ${route.time}</span>\n                            <span><i class=\"fas fa-coins\"></i> ${route.toll}</span>\n                        </div>\n                    </div>\n                    <div class=\"route-option-badge ${route.badge}\">\n                        ${route.badge.charAt(0).toUpperCase() + route.badge.slice(1).replace('-', ' ')}\n                    </div>\n                </div>\n            `).join('');

            // Display all routes on map
            routes.forEach((route, index) => {
                displayRouteOnMap(route, index === 0);
            });
        }

        // Display individual route on map
        function displayRouteOnMap(route, isActive) {
            const routeControl = L.Routing.control({
                waypoints: route.waypoints.map(coords => L.latLng(coords[0], coords[1])),
                routeWhileDragging: false,
                showAlternatives: false,
                lineOptions: {
                    styles: [{
                        color: route.color,
                        opacity: isActive ? 0.8 : 0.4,
                        weight: isActive ? 5 : 3
                    }]
                },
                createMarker: function () { return null; },
                addWaypoints: false
            }).addTo(map);

            alternativeRoutesControls.push(routeControl);
        }

        // Select alternative route
        function selectAlternativeRoute(routeId, index) {
            // Update active state
            document.querySelectorAll('.route-option').forEach((el, i) => {
                el.classList.remove('active');
                if (i === index) {
                    el.classList.add('active');
                }
            });

            // Clear and redisplay routes with updated active state
            clearAlternativeRoutes();
            loadAlternativeRoutes();

            showToast('Route Selected', `Switched to ${routeId}`, 'success', 2000);
        }

        // Clear alternative routes from map
        function clearAlternativeRoutes() {
            alternativeRoutesControls.forEach(control => {
                map.removeControl(control);
            });
            alternativeRoutesControls = [];
        }

        // Open Street View Panel
        function openStreetViewPanel() {
            const panel = document.getElementById('streetViewPanel');
            const btn = document.getElementById('streetViewBtn');

            streetViewActive = !streetViewActive;

            if (streetViewActive) {
                panel.style.display = 'block';
                btn.classList.add('active');
                showToast('Street View', 'Click on the map to preview street view', 'info', 3000);
            } else {
                closeStreetViewPanel();
            }
        }

        // Close Street View Panel
        function closeStreetViewPanel() {
            const panel = document.getElementById('streetViewPanel');
            const btn = document.getElementById('streetViewBtn');

            panel.style.display = 'none';
            btn.classList.remove('active');
            streetViewActive = false;
        }

        // Show Street View at location
        function showStreetView(lat, lng) {
            const frame = document.getElementById('streetViewFrame');

            // Google Street View embed URL
            const streetViewUrl = `https://www.google.com/maps/embed/v1/streetview?key=YOUR_GOOGLE_MAPS_API_KEY&location=${lat},${lng}&heading=0&pitch=0&fov=90`;

            // For demo without API key, show OpenStreetMap instead
            const demoUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lng - 0.01},${lat - 0.01},${lng + 0.01},${lat + 0.01}&layer=mapnik&marker=${lat},${lng}`;

            frame.src = demoUrl;

            showToast('Street View', 'Loading street view preview...', 'success', 2000);
        }

        // ========================================
        // END OF ADVANCED MAP FEATURES
        // ========================================

        // Toast Notification System
        function showToast(title, message, type = 'success', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.id = toastId;

            let icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            if (type === 'warning') icon = 'fa-exclamation-triangle';
            if (type === 'info') icon = 'fa-info-circle';

            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="removeToast('${toastId}')">
                    <i class="fas fa-times"></i>
                </button>
            `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            if (duration > 0) {
                setTimeout(() => {
                    removeToast(toastId);
                }, duration);
            }

            return toastId;
        }

        function removeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                toast.classList.add('hide');

                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }

        // ========================================
        // WEATHER FORECAST FUNCTIONS
        // ========================================
        let weatherData = {};

        async function fetchWeatherData(city, type) {
            try {
                // Using OpenWeatherMap API - replace with your API key
                const API_KEY = 'demo'; // Replace with actual API key or use demo data

                // For demo purposes, generate mock weather data
                const mockWeather = generateMockWeather(city);
                weatherData[type] = mockWeather;
                updateWeatherDisplay();

                // Uncomment below for real API integration
                // const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city},IN&appid=${API_KEY}&units=metric`);
                // if (response.ok) {
                //     const data = await response.json();
                //     weatherData[type] = {
                //         temp: Math.round(data.main.temp),
                //         feels_like: Math.round(data.main.feels_like),
                //         description: data.weather[0].description,
                //         icon: data.weather[0].main,
                //         humidity: data.main.humidity,
                //         wind: Math.round(data.wind.speed * 3.6),
                //         city: city
                //     };
                //     updateWeatherDisplay();
                // }
            } catch (error) {
                console.error('Error fetching weather:', error);
                showWeatherError();
            }
        }

        function generateMockWeather(city) {
            const conditions = ['Clear', 'Clouds', 'Rain', 'Sunny'];
            const condition = conditions[Math.floor(Math.random() * conditions.length)];
            return {
                temp: Math.round(20 + Math.random() * 15),
                feels_like: Math.round(20 + Math.random() * 15),
                description: condition.toLowerCase(),
                icon: condition,
                humidity: Math.round(40 + Math.random() * 40),
                wind: Math.round(5 + Math.random() * 20),
                city: city
            };
        }

        function updateWeatherDisplay() {
            const weatherSection = document.getElementById('weatherSection');
            const weatherGrid = document.getElementById('weatherGrid');

            if (!weatherData.pickup && !weatherData.drop) {
                weatherSection.style.display = 'none';
                return;
            }

            weatherSection.style.display = 'block';
            weatherGrid.innerHTML = '';

            if (weatherData.pickup) {
                weatherGrid.appendChild(createWeatherCard(weatherData.pickup, 'Pickup Location'));
            }

            if (weatherData.drop) {
                weatherGrid.appendChild(createWeatherCard(weatherData.drop, 'Drop Location'));
            }
        }

        function createWeatherCard(data, label) {
            const card = document.createElement('div');
            card.className = 'weather-card';

            const iconMap = {
                'Clear': '☀️',
                'Sunny': '☀️',
                'Clouds': '☁️',
                'Rain': '🌧️',
                'Snow': '❄️',
                'Thunderstorm': '⛈️'
            };

            card.innerHTML = `
                <div class="weather-card-header">
                    <div>
                        <div class="weather-location">${label}</div>
                        <div style="font-weight: 600; color: white; margin-top: 5px;">${data.city}</div>
                    </div>
                    <div class="weather-icon">${iconMap[data.icon] || '🌤️'}</div>
                </div>
                <div class="weather-temp">${data.temp}°C</div>
                <div class="weather-desc">${data.description.charAt(0).toUpperCase() + data.description.slice(1)}</div>
                <div class="weather-details">
                    <div class="weather-detail">
                        <i class="fas fa-temperature-high"></i>
                        <span>Feels like ${data.feels_like}°C</span>
                    </div>
                    <div class="weather-detail">
                        <i class="fas fa-tint"></i>
                        <span>Humidity ${data.humidity}%</span>
                    </div>
                    <div class="weather-detail">
                        <i class="fas fa-wind"></i>
                        <span>Wind ${data.wind} km/h</span>
                    </div>
                </div>
            `;

            return card;
        }

        function showWeatherError() {
            const weatherGrid = document.getElementById('weatherGrid');
            weatherGrid.innerHTML = `
                <div class="weather-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Unable to load weather data. Please try again later.</p>
                </div>
            `;
        }

        // ========================================
        // ROUTE OPTIMIZATION WITH WAYPOINTS
        // ========================================
        let waypoints = [];
        let waypointMarkers = [];

        function addWaypoint() {
            const waypointId = 'waypoint-' + Date.now();
            const waypointNumber = waypoints.length + 1;

            waypoints.push({
                id: waypointId,
                city: '',
                coords: null
            });

            const waypointsList = document.getElementById('waypointsList');
            const waypointItem = document.createElement('div');
            waypointItem.className = 'waypoint-item';
            waypointItem.id = waypointId;
            waypointItem.innerHTML = `
                <div class="waypoint-number">${waypointNumber}</div>
                <div class="waypoint-input autocomplete-wrapper">
                    <input type="text" 
                           id="${waypointId}-input" 
                           placeholder="Enter stop location..." 
                           autocomplete="off"
                           onchange="updateWaypoint('${waypointId}', this.value)">
                    <div class="autocomplete-dropdown" id="${waypointId}-dropdown"></div>
                </div>
                <div class="waypoint-actions">
                    <button type="button" class="waypoint-action-btn" onclick="moveWaypointUp('${waypointId}')" title="Move up">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button type="button" class="waypoint-action-btn" onclick="moveWaypointDown('${waypointId}')" title="Move down">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <button type="button" class="waypoint-action-btn delete" onclick="removeWaypoint('${waypointId}')" title="Remove">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            waypointsList.appendChild(waypointItem);

            // Setup autocomplete for this waypoint
            setupWaypointAutocomplete(waypointId);

            // Show optimize button if we have waypoints
            updateOptimizeButton();

            showToast('Waypoint Added', 'Add a stop location along your route', 'success', 2000);
        }

        function setupWaypointAutocomplete(waypointId) {
            const input = document.getElementById(waypointId + '-input');
            const dropdown = document.getElementById(waypointId + '-dropdown');

            if (!input || !dropdown) return;

            input.addEventListener('input', function () {
                const query = this.value.toLowerCase();

                if (query.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }

                const cities = Object.keys(cityCoordinates);
                const matches = cities.filter(city => city.toLowerCase().includes(query));

                if (matches.length > 0) {
                    dropdown.innerHTML = matches.slice(0, 5).map(city => `
                        <div class="autocomplete-item" onclick="selectWaypointCity('${waypointId}', '${city}')">
                            <i class="fas fa-map-marker-alt"></i> ${city}
                        </div>
                    `).join('');
                    dropdown.classList.add('show');
                } else {
                    dropdown.classList.remove('show');
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }

        function selectWaypointCity(waypointId, city) {
            const input = document.getElementById(waypointId + '-input');
            const dropdown = document.getElementById(waypointId + '-dropdown');

            if (input) input.value = city;
            if (dropdown) dropdown.classList.remove('show');

            updateWaypoint(waypointId, city);
        }

        function updateWaypoint(waypointId, city) {
            const waypoint = waypoints.find(w => w.id === waypointId);
            if (waypoint) {
                waypoint.city = city;
                waypoint.coords = cityCoordinates[city] || null;

                if (waypoint.coords) {
                    // Add marker to map
                    addWaypointMarker(waypoint);
                    // Recalculate route
                    if (pickupCoords && dropCoords) {
                        calculateRouteWithWaypoints();
                    }
                }
            }
            triggerAutoSave();
        }

        function addWaypointMarker(waypoint) {
            // Remove existing marker if any
            const existingMarker = waypointMarkers.find(m => m.id === waypoint.id);
            if (existingMarker && existingMarker.marker) {
                map.removeLayer(existingMarker.marker);
            }

            if (!waypoint.coords) return;

            const waypointIcon = L.divIcon({
                className: 'custom-waypoint-icon',
                html: '<div style="background: #FFC107; color: #000; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">•</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            const marker = L.marker(waypoint.coords, { icon: waypointIcon }).addTo(map);
            marker.bindPopup('<b>Stop:</b><br>' + waypoint.city);

            // Store marker reference
            const markerIndex = waypointMarkers.findIndex(m => m.id === waypoint.id);
            if (markerIndex >= 0) {
                waypointMarkers[markerIndex].marker = marker;
            } else {
                waypointMarkers.push({ id: waypoint.id, marker: marker });
            }
        }

        function removeWaypoint(waypointId) {
            // Remove from array
            waypoints = waypoints.filter(w => w.id !== waypointId);

            // Remove marker from map
            const markerData = waypointMarkers.find(m => m.id === waypointId);
            if (markerData && markerData.marker) {
                map.removeLayer(markerData.marker);
            }
            waypointMarkers = waypointMarkers.filter(m => m.id !== waypointId);

            // Remove DOM element
            const element = document.getElementById(waypointId);
            if (element) element.remove();

            // Renumber remaining waypoints
            renumberWaypoints();

            // Update route
            if (pickupCoords && dropCoords) {
                calculateRouteWithWaypoints();
            }

            updateOptimizeButton();
            showToast('Removed', 'Waypoint removed', 'info', 2000);
        }

        function moveWaypointUp(waypointId) {
            const index = waypoints.findIndex(w => w.id === waypointId);
            if (index > 0) {
                [waypoints[index], waypoints[index - 1]] = [waypoints[index - 1], waypoints[index]];
                renumberWaypoints();
                if (pickupCoords && dropCoords) {
                    calculateRouteWithWaypoints();
                }
            }
        }

        function moveWaypointDown(waypointId) {
            const index = waypoints.findIndex(w => w.id === waypointId);
            if (index < waypoints.length - 1) {
                [waypoints[index], waypoints[index + 1]] = [waypoints[index + 1], waypoints[index]];
                renumberWaypoints();
                if (pickupCoords && dropCoords) {
                    calculateRouteWithWaypoints();
                }
            }
        }

        function renumberWaypoints() {
            const waypointsList = document.getElementById('waypointsList');
            const items = Array.from(waypointsList.children);

            waypoints.forEach((waypoint, index) => {
                const element = document.getElementById(waypoint.id);
                if (element) {
                    const numberEl = element.querySelector('.waypoint-number');
                    if (numberEl) numberEl.textContent = index + 1;

                    // Reorder in DOM
                    waypointsList.appendChild(element);
                }
            });
        }

        function updateOptimizeButton() {
            const optimizeBtn = document.getElementById('optimizeRouteBtn');
            if (waypoints.length > 0) {
                optimizeBtn.style.display = 'flex';
            } else {
                optimizeBtn.style.display = 'none';
            }
        }

        function optimizeRoute() {
            if (waypoints.length === 0) return;

            // Simple optimization: calculate all permutations and find shortest
            // For production, use a proper TSP solver or Google Maps Directions API

            showToast('Optimizing', 'Calculating optimal route...', 'info', 2000);

            // Simulate optimization delay
            setTimeout(() => {
                // Mock optimization - in reality, this would calculate distances
                const originalDistance = estimatedDistance;
                const saved = Math.round(Math.random() * 50 + 10);
                const timeSaved = Math.round(saved / 60 * 60);

                document.getElementById('distanceSaved').textContent = saved + ' km';
                document.getElementById('timeSaved').textContent = timeSaved + ' mins';
                document.getElementById('optimizationResult').classList.add('show');

                showToast('Optimized!', `Route optimized to save ${saved}km`, 'success', 3000);

                // Recalculate route with optimized order
                calculateRouteWithWaypoints();
            }, 1500);
        }

        function calculateRouteWithWaypoints() {
            if (!pickupCoords || !dropCoords) return;

            if (routingControl) {
                map.removeControl(routingControl);
            }

            // Build waypoints array: pickup -> all stops -> drop
            const routeWaypoints = [L.latLng(pickupCoords[0], pickupCoords[1])];

            waypoints.forEach(wp => {
                if (wp.coords) {
                    routeWaypoints.push(L.latLng(wp.coords[0], wp.coords[1]));
                }
            });

            routeWaypoints.push(L.latLng(dropCoords[0], dropCoords[1]));

            routingControl = L.Routing.control({
                waypoints: routeWaypoints,
                routeWhileDragging: false,
                showAlternatives: false,
                lineOptions: {
                    styles: [{ color: '#ff6347', opacity: 0.8, weight: 5 }]
                },
                createMarker: function () { return null; },
                addWaypoints: false
            }).addTo(map);

            routingControl.on('routesfound', function (e) {
                const route = e.routes[0];
                const distance = (route.summary.totalDistance / 1000).toFixed(2);
                const time = (route.summary.totalTime / 3600).toFixed(1);
                const cost = Math.round(distance * 15);

                document.getElementById('routeDistance').textContent = distance + ' km';
                document.getElementById('routeTime').textContent = time + ' hours';
                document.getElementById('routeCost').textContent = '₹ ' + cost.toLocaleString();

                document.getElementById('routeInfo').classList.add('show');

                const stopsText = waypoints.length > 0 ? ` with ${waypoints.length} stop(s)` : '';
                showToast('Route Updated', `Distance: ${distance}km${stopsText}`, 'success', 3000);
            });

            const bounds = L.latLngBounds(routeWaypoints);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // ========================================
        // DOM CONTENT LOADED - INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize map first
            initMap();

            // Setup city autocomplete
            setupCityAutocomplete();

            // Initialize BookingManager (if using modular approach)
            // window.bookingManager = new BookingManager();

            const bookingForm = document.getElementById('bookingForm');
            const submitBtn = document.getElementById('submitBtn');
            const successModal = document.getElementById('successModal');
            const bookingRef = document.getElementById('bookingRef');

            // Check for resume link first
            checkResumeLink();

            // Try to restore saved form data
            restoreFormData();

            // Initialize date input minimum value
            const dateInput = document.getElementById('pickupDate');
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;

            // Add date validation for blackout dates
            dateInput.addEventListener('change', function () {
                validatePickupDate();
                updateBookingSummary();
                triggerAutoSave();
            });

            // Add input event listeners for real-time validation
            const validationFields = ['fullName', 'phone', 'email', 'vehicleType', 'pickupCity', 'dropCity', 'pickupDate'];

            validationFields.forEach(field => {
                const input = document.getElementById(field);
                if (input) {
                    input.addEventListener('input', function () {
                        validateField(field, this.value);
                        updateBookingSummary();
                    });

                    input.addEventListener('blur', function () {
                        validateField(field, this.value);
                    });
                }
            });

            // Character counter for textarea
            const additionalInfo = document.getElementById('additionalInfo');
            additionalInfo.addEventListener('input', updateCharacterCount);

            // Phone number formatting
            const phoneInput = document.getElementById('phone');
            phoneInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0) {
                    value = value.substring(0, 10);
                    if (value.length > 5) {
                        value = value.substring(0, 5) + ' ' + value.substring(5);
                    }
                }
                e.target.value = value;
            });

            // Vehicle type change - update pricing
            document.getElementById('vehicleType').addEventListener('change', function () {
                updatePriceCalculation();
                updateBookingSummary();
            });

            // Distance slider - initialize with estimated distance if cities selected
            const distanceSlider = document.getElementById('distanceSlider');
            distanceSlider.addEventListener('input', function () {
                updatePriceCalculation();
                updateBookingSummary();
            });

            // Initialize price calculation on load
            updatePriceCalculation();

            // Pickup date change
            document.getElementById('pickupDate').addEventListener('change', function () {
                updateBookingSummary();
            });

            // Pickup time change
            document.getElementById('pickupTime').addEventListener('change', function () {
                updateBookingSummary();
            });

            // Form submission
            bookingForm.addEventListener('submit', function (e) {
                e.preventDefault();

                if (!validateStep(3)) {
                    showToast('Validation Error', 'Please check all fields', 'error', 3000);
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Processing...</span>';

                // Simulate API call
                setTimeout(() => {
                    const reference = generateBookingRef();
                    bookingRef.textContent = reference;

                    // Create confetti
                    createConfetti();

                    // Show success modal
                    successModal.style.display = 'flex';

                    // Reset form
                    bookingForm.reset();
                    currentStep = 1;
                    updateStepDisplay();
                    updateProgressBar();
                    clearRoute();
                    updateBookingSummary();

                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i><span>Confirm Booking</span>';

                    showToast(
                        'Booking Confirmed!',
                        `Your booking reference is ${reference}`,
                        'success',
                        5000
                    );
                }, 2000);
            });

            function generateBookingRef() {
                const prefix = 'HC';
                const year = new Date().getFullYear();
                const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                return `${prefix}${year}-${randomNum}`;
            }
        });

        // ========================================
        // MODAL FUNCTIONS
        // ========================================
        function closeModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        window.addEventListener('click', function (e) {
            const modal = document.getElementById('successModal');
            if (e.target === modal) {
                closeModal();
            }
        });

        // ========================================
        // ADD-ON SERVICES
        // ========================================
        let selectedAddons = [];
        let addonsTotalPrice = 0;

        function toggleAddon(element, addonId, price) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                element.classList.add('selected');
                selectedAddons.push({ id: addonId, price: price });
                addonsTotalPrice += price;
            } else {
                element.classList.remove('selected');
                selectedAddons = selectedAddons.filter(a => a.id !== addonId);
                addonsTotalPrice -= price;
            }

            updateAddonsDisplay();
            updatePriceCalculation();
            triggerAutoSave();
        }

        function updateAddonsDisplay() {
            const addonsTotal = document.getElementById('addonsTotal');
            const addonsPrice = document.getElementById('addonsPrice');

            if (addonsTotalPrice > 0) {
                addonsTotal.style.display = 'flex';
                addonsPrice.textContent = '₹ ' + addonsTotalPrice.toLocaleString();
            } else {
                addonsTotal.style.display = 'none';
            }
        }

        // ========================================
        // POPULAR ROUTES - QUICK FILL
        // ========================================
        function fillRoute(fromCity, toCity) {
            document.getElementById('pickupCity').value = fromCity;
            document.getElementById('dropCity').value = toCity;

            selectedPickupCity = fromCity;
            selectedDropCity = toCity;

            // Trigger validations
            validateField('pickupCity', fromCity);
            validateField('dropCity', toCity);

            // Fetch weather for both cities
            fetchWeatherData(fromCity, 'pickup');
            fetchWeatherData(toCity, 'drop');

            // Calculate distance
            calculateDistanceEstimate();

            // Update summary
            updateBookingSummary();

            // Auto-save
            triggerAutoSave();

            // First, try to use city coordinates from our database
            const pickupCoord = cityCoordinates[fromCity];
            const dropCoord = cityCoordinates[toCity];

            if (pickupCoord && dropCoord) {
                // Use coordinates from database
                setPickupLocation(pickupCoord[0], pickupCoord[1], fromCity);
                setDropLocation(dropCoord[0], dropCoord[1], toCity);

                // Calculate and show route
                setTimeout(() => {
                    calculateRoute();
                }, 500);

                // Scroll to map section
                setTimeout(() => {
                    const mapSection = document.querySelector('.map-section');
                    if (mapSection) {
                        mapSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 1000);
            } else {
                // Fallback to geocoding API
                geocodeCity(fromCity, (pickupLatLng) => {
                    if (pickupLatLng) {
                        setPickupLocation(pickupLatLng[0], pickupLatLng[1], fromCity);

                        // Then geocode drop city
                        geocodeCity(toCity, (dropLatLng) => {
                            if (dropLatLng) {
                                setDropLocation(dropLatLng[0], dropLatLng[1], toCity);

                                // Calculate and show route
                                setTimeout(() => {
                                    calculateRoute();
                                }, 500);
                            }
                        });
                    }
                });

                // Scroll to map section
                setTimeout(() => {
                    const mapSection = document.querySelector('.map-section');
                    if (mapSection) {
                        mapSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 1000);
            }

            // Show toast
            showToast('Route Selected', `${fromCity} → ${toCity}`, 'success', 2000);

            // Track analytics
            trackAnalytics('route_select', { from: fromCity, to: toCity });

            // Jump to step 2 if on step 1
            if (currentStep === 1) {
                setTimeout(() => {
                    const vehicleType = document.getElementById('vehicleType').value;
                    if (vehicleType) {
                        nextStep();
                    }
                }, 500);
            }
        }

        // ========================================
        // BOOKING MANAGEMENT FUNCTIONS
        // ========================================
        // Functions moved to booking-modals.js

        // ========================================
        // CART ABANDONMENT RECOVERY
        // ========================================
        // Functions moved to booking-modals.js

        // ========================================
        // ANALYTICS TRACKING
        // ========================================
        const analyticsData = {
            pageViews: 0,
            formStarts: 0,
            step1Completions: 0,
            step2Completions: 0,
            bookingSubmissions: 0,
            abandonments: 0,
            popularRoutes: {},
            conversionRate: 0
        };

        function trackAnalytics(event, data = {}) {
            // Update analytics data
            switch (event) {
                case 'page_view':
                    analyticsData.pageViews++;
                    break;
                case 'form_start':
                    analyticsData.formStarts++;
                    break;
                case 'step_1_complete':
                    analyticsData.step1Completions++;
                    break;
                case 'step_2_complete':
                    analyticsData.step2Completions++;
                    break;
                case 'booking_submit':
                    analyticsData.bookingSubmissions++;
                    break;
                case 'cart_abandonment':
                    analyticsData.abandonments++;
                    break;
                case 'route_select':
                    const route = `${data.from}_${data.to}`;
                    analyticsData.popularRoutes[route] = (analyticsData.popularRoutes[route] || 0) + 1;
                    break;
            }

            // Calculate conversion rate
            if (analyticsData.formStarts > 0) {
                analyticsData.conversionRate = (analyticsData.bookingSubmissions / analyticsData.formStarts * 100).toFixed(2);
            }

            // Save to localStorage
            localStorage.setItem('bookingAnalytics', JSON.stringify(analyticsData));

            // In production, send to analytics service (Google Analytics, Mixpanel, etc.)
            console.log('Analytics Event:', event, data, analyticsData);
        }

        // Track page view on load
        trackAnalytics('page_view');

        // Track when user starts filling the form
        let formStartTracked = false;
        document.querySelectorAll('#bookingForm input, #bookingForm select').forEach(input => {
            input.addEventListener('focus', function () {
                if (!formStartTracked) {
                    trackAnalytics('form_start');
                    formStartTracked = true;
                }
            });
        });

        // ========================================
        // ENHANCED PRICE CALCULATION WITH ADDONS
        // ========================================
        const originalUpdatePriceCalculation = updatePriceCalculation;
        updatePriceCalculation = function () {
            originalUpdatePriceCalculation();

            // Add addons to total
            if (addonsTotalPrice > 0) {
                const currentTotal = parseFloat(document.getElementById('totalPrice').textContent.replace(/[₹,]/g, '')) || 0;
                const newTotal = currentTotal + addonsTotalPrice;
                document.getElementById('totalPrice').textContent = '₹ ' + newTotal.toLocaleString();
            }
        };
    </script>
    <!-- Footer -->
    <div id="footer-container"></div>
    <script src="../js/modules/footer-loader.js"></script>

    <!-- 🌟 Bottom Fixed Action Bar -->
   <link rel="stylesheet" href="../css/components/footer.css" />
  <link rel="stylesheet" href="../css/components/sticky-quote-button.css" />
  <link rel="stylesheet" href="../css/components/quote-modal.css" />
  <link rel="stylesheet" href="../css/components/bottom-fixed-container.css">
  
  <!-- 🚀 Floating Action Menu loaded via footer component -->
   <!-- test change for git -->
   <script src="../js/script.js"></script>
</body>

</html>